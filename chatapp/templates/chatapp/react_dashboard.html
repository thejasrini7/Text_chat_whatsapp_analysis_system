{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{ csrf_token }}" />
  <title>Analytics Dashboard • WhatsApp Chat Analyzer</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%23128C7E'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial, sans-serif' font-size='28' fill='white'%3EW%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <!-- PropTypes for compatibility -->
  <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <!-- Recharts with multiple fallback CDNs -->
  <script crossorigin src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js" 
    onload="console.log('✅ Recharts loaded successfully from primary CDN (unpkg)');"
    onerror="
      console.error('❌ Primary Recharts CDN (unpkg) failed, trying jsdelivr fallback...');
      this.onerror=function(){
        console.error('❌ Second CDN (jsdelivr) failed, trying manual injection...');
        const script = document.createElement('script');
        script.crossOrigin = 'anonymous';
        script.src = 'https://cdn.skypack.dev/recharts@2.8.0';
        script.onload = () => console.log('✅ Recharts loaded from skypack fallback');
        script.onerror = () => console.error('❌ All Recharts CDN sources failed');
        document.head.appendChild(script);
      };
      this.src='https://cdn.jsdelivr.net/npm/recharts@2.8.0/umd/Recharts.js';
    ">
  </script>
  <!-- Chart.js for sentiment analysis charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- Babel for transpiling -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --primary: #128C7E;
      --primary-dark: #075E54;
      --secondary: #25D366;
      --bg-light: #f8fafc;
      --bg-white: #ffffff;
      --text-dark: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --sidebar-width: 280px;
      --header-height: 70px;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --gradient: linear-gradient(135deg, #128C7E 0%, #25D366 100%);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--bg-white);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      color: var(--text-dark);
      font-size: 1.25rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--border);
      color: var(--text-dark);
    }

    .modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .modal-actions {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .group-item {
      padding: 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .group-item:hover {
      background: var(--bg-light);
      border-color: var(--primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .group-item i {
      color: var(--primary);
      font-size: 1.1rem;
    }

    .group-item span {
      font-weight: 500;
      color: var(--text-dark);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 3rem;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .empty-state p {
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
    }

    .loading i {
      margin-right: 10px;
    }

    .error {
      text-align: center;
      padding: 20px;
      color: var(--error);
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      overflow-x: hidden;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: var(--bg-white);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      z-index: 1000;
      box-shadow: var(--shadow);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 700;
      font-size: 1.25rem;
      color: var(--primary);
      text-decoration: none;
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .group-name {
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.1) 0%, rgba(37, 211, 102, 0.1) 100%);
      color: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      border: 1px solid rgba(18, 140, 126, 0.2);
    }

    .btn-header {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      background: var(--bg-white);
      color: var(--text-muted);
      border-radius: 0.375rem;
      text-decoration: none;
      font-size: 0.875rem;
      transition: all 0.3s ease;
    }

    .btn-header:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: var(--header-height);
      left: 0;
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height));
      background: var(--bg-white);
      border-right: 1px solid var(--border);
      padding: 1.5rem 0;
      overflow-y: auto;
      z-index: 999;
      box-shadow: var(--shadow);
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar-toggle {
      position: absolute;
      top: 1rem;
      right: -12px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .sidebar-toggle:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }

    .nav-menu {
      list-style: none;
      padding: 0 1rem;
    }

    .nav-item {
      margin-bottom: 0.5rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1rem;
      color: var(--text-muted);
      text-decoration: none;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
      position: relative;
    }

    .nav-link:hover {
      background: rgba(18, 140, 126, 0.05);
      color: var(--primary);
    }

    .nav-link.active {
      background: var(--gradient);
      color: white;
      box-shadow: var(--shadow);
    }

    .nav-link i {
      font-size: 1.125rem;
      width: 20px;
      text-align: center;
    }

    .nav-text {
      font-weight: 500;
      transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .nav-text {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar.collapsed .nav-link {
      justify-content: center;
    }

    /* Main Content */
    .main-content {
      margin-left: var(--sidebar-width);
      margin-top: var(--header-height);
      padding: 2rem;
      min-height: calc(100vh - var(--header-height));
      transition: margin-left 0.3s ease;
    }

    .sidebar.collapsed ~ .main-content {
      margin-left: 70px;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 1.125rem;
    }

    .content-area {
      background: var(--bg-white);
      border-radius: 1rem;
      box-shadow: var(--shadow);
      min-height: 600px;
      position: relative;
    }

    .section-content {
      padding: 2rem;
      display: none;
    }

    .section-content.active {
      display: block;
    }

    .card {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .card-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .btn-primary {
      background: var(--gradient);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(18, 140, 126, 0.3);
    }

    .btn-secondary {
      background: var(--bg-white);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
      color: var(--text-dark);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 140, 126, 0.1);
    }

    .date-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .result-area {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--bg-light);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      min-height: 200px;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .badge {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .badge-error { background: rgba(239, 68, 68, 0.1); color: var(--error); }

    /* Summary Section Styles */
    .summary-main-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .summary-main-btn {
      padding: 1rem;
      height: auto;
      flex-direction: column;
      text-align: center;
      font-size: 1rem;
      font-weight: 600;
    }

    .summary-main-btn i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .summary-main-btn.btn-primary {
      background: var(--gradient);
      border: none;
      color: white;
      box-shadow: var(--shadow);
    }

    .summary-main-btn.btn-secondary {
      background: var(--bg-white);
      color: var(--text-muted);
      border: 2px solid var(--border);
    }

    .summary-main-btn.btn-secondary:hover {
      background: var(--gradient);
      color: white;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .summary-sub-section {
      margin-bottom: 1.5rem;
    }

    .summary-sub-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .summary-sub-buttons .btn {
      padding: 1.25rem;
      height: auto;
      flex-direction: column;
      text-align: center;
      font-size: 1rem;
      position: relative;
    }

    .summary-sub-buttons .btn i {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .btn-subtitle {
      display: block;
      font-size: 0.75rem;
      font-weight: 400;
      opacity: 0.8;
      margin-top: 0.25rem;
      line-height: 1.2;
    }

    .user-selection-area {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-light);
      border-radius: 0.5rem;
      border: 1px solid var(--border);
    }

    /* Results formatting */
    .weekly-summary-item {
      background: var(--bg-light);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .weekly-summary-header {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .daily-summary-item {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .daily-summary-date {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .user-message-item {
      background: var(--bg-light);
      border-left: 3px solid var(--primary);
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: 0 0.25rem 0.25rem 0;
    }

    .message-datetime {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .message-text {
      color: var(--text-dark);
      line-height: 1.4;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.collapsed {
        transform: translateX(0);
        width: 70px;
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .sidebar.collapsed ~ .main-content {
        margin-left: 70px;
      }
    }

    @media (max-width: 768px) {
      .main-content {
        padding: 1rem;
      }
      
      .page-title {
        font-size: 1.5rem;
      }
      
      .date-range {
        grid-template-columns: 1fr;
      }
      
      .header {
        padding: 0 1rem;
      }
      
      .group-name {
        display: none;
      }
    }

    /* Sentiment Analysis Dashboard Styles */
    .sentiment-dashboard {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    .sentiment-header {
      margin-bottom: 2rem;
      position: relative;
    }

    .sentiment-title {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .sentiment-icon {
      color: #E04F4F;
      font-size: 1.5rem;
    }

    .sentiment-divider {
      height: 1px;
      background: linear-gradient(to right, var(--border), transparent);
      width: 100%;
    }

    /* Controls */
    .sentiment-controls {
      background: var(--bg-white);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .date-controls-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .date-input-group {
      display: flex;
      flex-direction: column;
    }

    .date-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .sentiment-date-input {
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: var(--bg-white);
    }

    .sentiment-date-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 140, 126, 0.1);
    }

    .sentiment-analyze-btn {
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.875rem 2rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }

    .sentiment-analyze-btn:hover {
      background: #1EBE55;
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    }

    .sentiment-analyze-btn:active {
      transform: translateY(0);
    }

    /* Sentiment Overview Cards */
    .sentiment-overview {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .sentiment-card {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .sentiment-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      transition: all 0.3s ease;
    }

    .sentiment-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .sentiment-card:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Positive Card */
    .positive-card {
      background: linear-gradient(135deg, #EAF8F0 0%, #F0FDF4 100%);
      border-color: rgba(45, 180, 110, 0.2);
    }

    .positive-card::before {
      background: #2DB46E;
    }

    .positive-card:hover::before {
      width: 6px;
    }

    /* Neutral Card */
    .neutral-card {
      background: linear-gradient(135deg, #F5F6F7 0%, #F9FAFB 100%);
      border-color: rgba(136, 136, 136, 0.2);
    }

    .neutral-card::before {
      background: #888888;
    }

    .neutral-card:hover::before {
      width: 6px;
    }

    /* Negative Card */
    .negative-card {
      background: linear-gradient(135deg, #FDECEC 0%, #FEF2F2 100%);
      border-color: rgba(224, 79, 79, 0.2);
    }

    .negative-card::before {
      background: #E04F4F;
    }

    .negative-card:hover::before {
      width: 6px;
    }

    .sentiment-number {
      font-size: 3rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      line-height: 1;
    }

    .sentiment-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Charts */
    .sentiment-charts {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .chart-container {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-area {
      position: relative;
      background: var(--bg-light);
      border-radius: 0.75rem;
      padding: 1rem;
      min-height: 300px;
      overflow: hidden;
    }

    .chart-area canvas {
      width: 100% !important;
      height: auto !important;
    }

    /* Loading State */
    .sentiment-loading {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 3rem;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .sentiment-loading p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* Empty State */
    .sentiment-empty {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 3rem;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .sentiment-empty i {
      font-size: 3rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .sentiment-empty h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .sentiment-empty p {
      color: var(--text-muted);
      font-size: 0.875rem;
      max-width: 400px;
      margin: 0 auto;
    }

    /* Activity Analysis Dashboard Styles */
    .activity-dashboard {
      padding: 0;
    }

    .activity-header {
      margin-bottom: 2rem;
      position: relative;
    }

    .activity-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .activity-icon {
      color: var(--primary);
    }

    .activity-divider {
      height: 1px;
      background: linear-gradient(to right, var(--border), transparent);
      width: 100%;
    }

    .activity-controls {
      background: var(--bg-white);
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .activity-date-input {
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      font-size: 0.875rem;
      transition: all 0.3s ease;
      background: var(--bg-white);
    }

    .activity-date-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(18, 140, 126, 0.1);
    }

    .activity-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-start;
    }

    .activity-analyze-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.875rem 2rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(18, 140, 126, 0.3);
    }

    .activity-analyze-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(18, 140, 126, 0.4);
    }

    .activity-export-btn {
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.875rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .activity-export-btn:hover {
      background: #1EBE55;
      transform: translateY(-1px);
    }

    /* Quick Insights */
    .quick-insights {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .insight-card {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s ease;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .insight-icon {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .insight-content {
      flex: 1;
    }

    .insight-title {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .insight-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    /* Week Navigation */
    .week-navigation {
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 1rem;
    }

    .week-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .week-card {
      background: var(--bg-white);
      border: 2px solid var(--border);
      border-radius: 0.75rem;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .week-card:hover {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.05), rgba(37, 211, 102, 0.05));
      transform: translateY(-2px);
    }

    .week-card.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.1), rgba(37, 211, 102, 0.1));
    }

    .week-card-title {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .week-card-subtitle {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .week-card-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
    }

    .week-card-messages {
      color: var(--primary);
      font-weight: 600;
    }

    .week-card-users {
      color: var(--text-muted);
    }

    /* Analysis View */
    .analysis-view {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .period-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .period-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    .period-actions {
      display: flex;
      gap: 0.75rem;
    }

    .user-filter-section {
      margin-bottom: 2rem;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chart-actions {
      display: flex;
      gap: 0.5rem;
    }

    .chart-zoom-btn {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 0.375rem;
      padding: 0.5rem;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.3s ease;
    }

    .chart-zoom-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Leaderboard */
    .leaderboard-container {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .leaderboard-header {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .leaderboard-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .leaderboard {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--bg-light);
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .leaderboard-item:hover {
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.05), rgba(37, 211, 102, 0.05));
      transform: translateX(4px);
    }

    .leaderboard-rank {
      background: var(--primary);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .leaderboard-rank.top-3 {
      background: linear-gradient(135deg, #FFD700, #FFA500);
    }

    .leaderboard-user {
      flex: 1;
      font-weight: 500;
      color: var(--text-dark);
    }

    .leaderboard-count {
      color: var(--primary);
      font-weight: 600;
    }

    .leaderboard-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .leaderboard-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 2px;
      transition: width 1s ease;
    }

    /* Day Analysis Grid */
    .day-analysis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .user-messages-section {
      background: var(--bg-light);
      border-radius: 0.75rem;
      padding: 1.5rem;
    }

    .messages-list {
      max-height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .message-item {
      background: var(--bg-white);
      border-radius: 0.5rem;
      padding: 0.75rem;
      border-left: 3px solid var(--primary);
      font-size: 0.875rem;
    }

    .message-time {
      color: var(--text-muted);
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }

    .message-text {
      color: var(--text-dark);
      line-height: 1.4;
    }

    /* User Stats Grid */
    .user-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-light);
      border-radius: 0.75rem;
      padding: 1.5rem;
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .user-charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    /* Large Modal */
    .large-modal {
      max-width: 1200px;
      max-height: 90vh;
    }

    /* Tooltip Styles */
    .tooltip {
      position: absolute;
      top: 15px;
      right: 15px;
      display: inline-block;
    }

    .tooltip .tooltip-icon {
      background: var(--primary);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      cursor: help;
      transition: all 0.3s ease;
    }

    .tooltip .tooltip-icon:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }

    .tooltip .tooltip-content {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-dark);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.4;
      width: 300px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .tooltip .tooltip-content::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--text-dark) transparent transparent transparent;
    }

    .tooltip:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
    }

    .tooltip-content h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--secondary);
    }

    .tooltip-content p {
      margin: 0 0 8px 0;
    }

    .tooltip-content ul {
      margin: 8px 0 0 0;
      padding-left: 16px;
    }

    .tooltip-content li {
      margin: 4px 0;
    }

    /* Comprehensive History Styles */
    .history-item.comprehensive {
      background: var(--bg-white);
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .history-header {
      background: linear-gradient(135deg, rgba(18, 140, 126, 0.05) 0%, rgba(37, 211, 102, 0.05) 100%);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .status-icon {
      font-size: 1.2rem;
    }

    .analysis-type {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 1.1rem;
    }

    .analysis-date {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .history-actions {
      display: flex;
      gap: 0.5rem;
    }

    .history-content {
      padding: 1.5rem;
    }

    .history-section {
      margin-bottom: 1.5rem;
    }

    .history-section:last-child {
      margin-bottom: 0;
    }

    .history-section h4 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
    }

    .info-item {
      padding: 0.5rem;
      background: var(--bg-light);
      border-radius: 0.375rem;
      font-size: 0.9rem;
    }

    .highlights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 0.75rem;
    }

    .highlight-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: var(--bg-light);
      border-radius: 0.5rem;
      border-left: 3px solid var(--primary);
    }

    .highlight-item i {
      color: var(--primary);
      width: 16px;
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.5rem;
    }

    .result-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: rgba(18, 140, 126, 0.1);
      border-radius: 0.375rem;
      font-size: 0.9rem;
      color: var(--primary-dark);
    }

    .result-item i {
      color: var(--primary);
    }

    .btn-sm {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 0.375rem;
    }

    /* Q&A Modal Styles */
    .qa-input-section {
      margin-bottom: 2rem;
    }

    .question-input-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .question-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .question-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .quick-questions {
      margin-bottom: 1.5rem;
    }

    .quick-questions p {
      margin-bottom: 0.75rem;
      color: var(--text-dark);
      font-size: 0.9rem;
    }

    .quick-question-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .quick-chip {
      background: var(--bg-light);
      color: var(--text-dark);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .quick-chip:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }

    .qa-answer-section {
      margin: 2rem 0;
      padding: 1.5rem;
      background: var(--bg-light);
      border-radius: 12px;
      border-left: 4px solid var(--primary);
    }

    .answer-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      color: var(--primary);
      font-weight: 600;
    }

    .answer-content {
      color: var(--text-dark);
      line-height: 1.6;
    }

    .qa-loading {
      text-align: center;
      padding: 2rem;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .qa-help-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .qa-help-section h4 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .help-tips {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .help-tip {
      padding: 1rem;
      background: var(--bg-white);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .help-tip strong {
      color: var(--primary);
      display: block;
      margin-bottom: 0.5rem;
    }

    .help-tip {
      color: var(--text-muted);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* Permanent Q&A Section Styles */
    .qa-section-permanent {
      background: var(--bg-white);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .qa-header h4 {
      color: var(--primary);
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .qa-input-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .qa-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .qa-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .quick-questions-permanent {
      margin-bottom: 1rem;
    }

    .quick-questions-permanent .quick-question-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .qa-answer-display {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg-light);
      border-radius: 8px;
      border-left: 4px solid var(--primary);
    }

    .answer-content .answer-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      color: var(--primary);
      font-weight: 600;
    }

    .answer-text {
      color: var(--text-dark);
      line-height: 1.6;
    }

    /* Loading State */
    .activity-loading {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 3rem;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .activity-loading .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .activity-loading p {
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    /* Empty State */
    .activity-empty {
      background: var(--bg-white);
      border-radius: 1rem;
      padding: 3rem;
      text-align: center;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .activity-empty i {
      font-size: 3rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .activity-empty h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
    }

    .activity-empty p {
      color: var(--text-muted);
      font-size: 0.875rem;
      max-width: 400px;
      margin: 0 auto;
    }

    /* Responsive Design for Activity Dashboard */
    @media (max-width: 768px) {
      .quick-insights {
        grid-template-columns: 1fr;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .day-analysis-grid,
      .user-charts-grid {
        grid-template-columns: 1fr;
      }

      .period-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .activity-actions {
        flex-direction: column;
      }

      .activity-analyze-btn,
      .activity-export-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 2rem;
      backdrop-filter: blur(4px);
    }

    .modal-content {
      background: var(--bg-white);
      border-radius: 1rem;
      box-shadow: var(--shadow-lg);
      max-width: 800px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 0.375rem;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--bg-light);
      color: var(--text-dark);
    }

    .modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .message-item {
      background: var(--bg-light);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid #E04F4F;
    }

    .message-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .message-user {
      font-weight: 600;
      color: var(--text-dark);
    }

    .message-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .message-text {
      color: var(--text-dark);
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }

    .message-explanation {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-style: italic;
      padding: 0.75rem;
      background: var(--bg-white);
      border-radius: 0.5rem;
      border-left: 3px solid #E04F4F;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .sentiment-overview {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .date-controls-row {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .sentiment-card {
        padding: 1.5rem;
      }

      .sentiment-number {
        font-size: 2.5rem;
      }

      .modal-overlay {
        padding: 1rem;
      }

      .modal-content {
        max-height: 90vh;
      }

      .chart-area {
        padding: 0.5rem;
        min-height: 250px;
      }
    }

    @media (max-width: 480px) {
      .sentiment-controls {
        padding: 1rem;
      }

      .sentiment-analyze-btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Event Dashboard Card Styles */
    .events-dashboard {
      margin: 1rem 0;
    }

    .dashboard-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--text-dark);
    }

    .events-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .event-card {
      background: var(--bg-white);
      border-radius: 0.75rem;
      padding: 1.25rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
      overflow: hidden;
    }

    .event-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .event-icon {
      width: 60px;
      height: 60px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .event-icon svg {
      width: 24px;
      height: 24px;
    }

    .event-details-panel {
      margin-top: 1.5rem;
      background: var(--bg-light);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      overflow: hidden;
      display: none;
    }

    .event-details-panel.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .event-details-header {
      background: var(--bg-white);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .event-details-header h4 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .event-details-content {
      max-height: 400px;
      overflow-y: auto;
    }

    .event-log-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      transition: background 0.2s ease;
    }

    .event-log-item:hover {
      background: var(--bg-white);
    }

    .event-log-item:last-child {
      border-bottom: none;
    }

    .event-log-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      flex-shrink: 0;
    }

    .event-log-content {
      flex: 1;
    }

    .event-log-action {
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.25rem;
    }

    .event-log-details {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .event-log-timestamp {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .event-log-meta {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .event-log-sender,
    .event-log-timestamp {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .event-log-sender i,
    .event-log-timestamp i {
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .event-info {
      flex: 1;
    }

    .event-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .event-count {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-dark);
      line-height: 1;
      margin-bottom: 0.25rem;
    }

    .event-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .top-removers-section {
      background: var(--bg-white);
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-top: 1.5rem;
    }

    .top-removers-section h4 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-dark);
    }

    .removers-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .remover-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--bg-light);
      border-radius: 0.5rem;
      border-left: 3px solid var(--error);
    }

    .remover-rank {
      font-weight: 700;
      color: var(--text-muted);
      font-size: 0.875rem;
      min-width: 20px;
    }

    .remover-name {
      flex: 1;
      font-weight: 500;
      color: var(--text-dark);
    }

    .remover-count {
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Event Details Modal Styles */
    .event-details-modal {
      background: var(--bg-white);
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .event-details-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 1.5rem;
      text-align: center;
    }

    .event-details-header h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .event-details-header p {
      font-size: 1rem;
      opacity: 0.9;
    }

    .event-details-body {
      padding: 1.5rem;
    }

    .alert {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      border-left: 4px solid;
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border-left-color: #3b82f6;
      color: var(--text-dark);
    }

    .event-summary {
      background: var(--bg-light);
      padding: 1.25rem;
      border-radius: 0.5rem;
    }

    .event-summary ul {
      margin-top: 1rem;
      padding-left: 0;
      list-style: none;
    }

    .event-summary li {
      padding: 0.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-dark);
    }

    @media (max-width: 768px) {
      .events-grid {
        grid-template-columns: 1fr;
      }
      
      .event-card {
        padding: 1rem;
      }
      
      .event-icon {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
      }
      
      .event-count {
        font-size: 1.75rem;
      }

      .event-details-header {
        padding: 1rem;
      }

      .event-details-body {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="/home" class="header-brand">
      <i class="fab fa-whatsapp"></i>
      WhatsApp Chat Analyzer
    </a>
    <div class="header-actions">
      <div class="group-name" id="currentGroup">
        <i class="fas fa-users"></i>
        <span id="groupNameText">Loading...</span>
      </div>
      <a href="/home" class="btn-header">
        <i class="fas fa-home"></i> Home
      </a>
    </div>
  </header>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle">
      <i class="fas fa-chevron-left"></i>
    </button>
    <ul class="nav-menu">
      <li class="nav-item">
        <a href="#" class="nav-link active" data-section="summary">
          <i class="fas fa-file-alt"></i>
          <span class="nav-text">Generate Summary</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="questions">
          <i class="fas fa-question-circle"></i>
          <span class="nav-text">Ask Questions</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="events">
          <i class="fas fa-calendar-alt"></i>
          <span class="nav-text">Group Events</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="sentiment">
          <i class="fas fa-heart"></i>
          <span class="nav-text">Sentiment Analysis</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="activity">
          <i class="fas fa-chart-line"></i>
          <span class="nav-text">Activity Analysis</span>
        </a>
      </li>
      <li class="nav-item">
        
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-section="history">
          <i class="fas fa-history"></i>
          <span class="nav-text">History</span>
        </a>
      </li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <div class="page-header">
      <h1 class="page-title" id="pageTitle">Generate Summary</h1>
      <p class="page-subtitle" id="pageSubtitle">Create comprehensive summaries of your chat conversations</p>
    </div>

    <div class="content-area">
      <!-- Summary Section -->
      <div class="section-content active" id="summary-section">
        <!-- Main Summary Buttons -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-file-alt"></i>
              Summary Options
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Generate Summary</h4>
                  <p>Creates comprehensive summaries of your chat conversations using AI analysis.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Analyzes all messages in the selected date range</li>
                    <li>Identifies key topics and themes</li>
                    <li>Generates a structured summary with insights</li>
                  </ul>
                  <p><strong>Input:</strong> Select date range and click "Generate Summary"</p>
                </div>
              </div>
            </h3>
          </div>
          
          <!-- Main Buttons Row -->
          <div class="summary-main-buttons">
            <button class="btn btn-primary summary-main-btn" data-target="total-summary">
              <i class="fas fa-chart-line"></i>
              Total Summary
            </button>
            <button class="btn btn-secondary summary-main-btn" data-target="user-messages">
              <i class="fas fa-users"></i>
              User Messages
            </button>
          </div>
        </div>

        <!-- Date Range Selection (Common for all) -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-calendar"></i>
              Date Range
            </h3>
          </div>
          <div class="date-range">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="summaryStartDate">
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="summaryEndDate">
            </div>
          </div>
        </div>

        <!-- Total Summary Sub-options -->
        <div class="card summary-sub-section" id="total-summary" style="display: block;">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-chart-line"></i>
              Total Summary Options
            </h3>
          </div>
          <div class="summary-sub-buttons">
            <button class="btn btn-primary" id="generateWeeklySummary">
              <i class="fas fa-calendar-alt"></i>
              Weekly Report
              <small class="btn-subtitle">Automatic week-by-week breakdown</small>
            </button>
            <button class="btn btn-primary" id="generateBriefSummary">
              <i class="fas fa-file-text"></i>
              Brief Report
              <small class="btn-subtitle">Concise overview of main points</small>
            </button>
          </div>
        </div>

        <!-- User Messages Sub-options -->
        <div class="card summary-sub-section" id="user-messages" style="display: none;">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-users"></i>
              User Messages Options
            </h3>
          </div>
          <div class="summary-sub-buttons">
            <button class="btn btn-primary" id="generateDailyUserMessages">
              <i class="fas fa-calendar-day"></i>
              Show All User Messages
              <small class="btn-subtitle">Day-by-day with short summaries</small>
            </button>
            <button class="btn btn-primary" id="showUserWiseOptions">
              <i class="fas fa-user-edit"></i>
              User-wise Report
              <small class="btn-subtitle">Select user from dropdown</small>
            </button>
          </div>
          
          <!-- User Selection Dropdown (initially hidden) -->
          <div class="user-selection-area" id="userSelectionArea" style="display: none;">
            <div class="form-group">
              <label class="form-label">Select User</label>
              <select class="form-select" id="userDropdown">
                <option value="">Choose a user...</option>
              </select>
            </div>
            <button class="btn btn-primary" id="generateUserWiseReport">
              <i class="fas fa-user-circle"></i>
              Generate User Report
            </button>
          </div>
        </div>

        <!-- Results Area -->
        <div class="card">
          <div class="result-area" id="summaryResult">
            <div class="empty-state">
              <i class="fas fa-file-alt"></i>
              <p>Select a summary option above to analyze your chat</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Questions Section -->
      <div class="section-content" id="questions-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-question-circle"></i>
              Ask Questions About Your Chat
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Ask Questions</h4>
                  <p>Get AI-powered insights by asking questions about your chat data.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Uses advanced AI to understand your questions</li>
                    <li>Analyzes chat data to provide relevant answers</li>
                    <li>Handles various question types about users, messages, and patterns</li>
                  </ul>
                  <p><strong>Input:</strong> Type your question and click "Ask Question"</p>
                </div>
              </div>
            </h3>
          </div>
          <div class="form-group">
            <label class="form-label">Your Question</label>
            <textarea class="form-textarea" id="userQuestion" rows="3" 
                      placeholder="Ask anything about your chat... e.g., 'What were the main topics discussed?' or 'Who was most active?'"></textarea>
          </div>
          <div class="date-range">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="questionStartDate">
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="questionEndDate">
            </div>
          </div>
          <button class="btn btn-primary" id="askQuestion">
            <i class="fas fa-search"></i>
            Get Answer
          </button>
          <div class="result-area" id="questionResult">
            <div class="empty-state">
              <i class="fas fa-lightbulb"></i>
              <p>Ask a question to get insights from your chat data</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Events Section -->
      <div class="section-content" id="events-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-calendar-alt"></i>
              Group Events Analysis
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Group Events Analysis</h4>
                  <p>Tracks member changes and group activities in your WhatsApp group.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Detects when members are added, removed, or leave</li>
                    <li>Tracks group name and icon changes</li>
                    <li>Shows detailed information about each event</li>
                  </ul>
                  <p><strong>Input:</strong> Select date range and click "Analyze Events"</p>
                </div>
              </div>
            </h3>
          </div>
          <div class="date-range">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="eventsStartDate">
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="eventsEndDate">
            </div>
          </div>
          <button class="btn btn-primary" id="analyzeEvents">
            <i class="fas fa-chart-bar"></i>
            Analyze Events
          </button>
          <div class="result-area" id="eventsResult">
            <div class="empty-state">
              <i class="fas fa-calendar-check"></i>
              <p>Analyze group events like member additions, removals, and settings changes</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sentiment Section -->
      <div class="section-content" id="sentiment-section">
        <div class="sentiment-dashboard">
          <!-- Header -->
          <div class="sentiment-header">
            <h2 class="sentiment-title">
              <i class="fas fa-heart sentiment-icon"></i>
              Sentiment Analysis
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Sentiment Analysis</h4>
                  <p>Discovers emotional patterns and sentiment trends in your conversations.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Analyzes message sentiment (positive, negative, neutral)</li>
                    <li>Shows sentiment distribution over time</li>
                    <li>Identifies emotional patterns and trends</li>
                  </ul>
                  <p><strong>Input:</strong> Select date range and click "Analyze Sentiment"</p>
                </div>
              </div>
            </h2>
            <div class="sentiment-divider"></div>
          </div>

          <!-- Controls -->
          <div class="sentiment-controls">
            <div class="date-controls-row">
              <div class="date-input-group">
                <label class="date-label">Start Date</label>
                <input type="date" class="sentiment-date-input" id="sentimentStartDate">
              </div>
              <div class="date-input-group">
                <label class="date-label">End Date</label>
                <input type="date" class="sentiment-date-input" id="sentimentEndDate">
              </div>
            </div>
            <button class="sentiment-analyze-btn" id="analyzeSentiment">
              <i class="fas fa-brain"></i>
              Analyze Sentiment
            </button>
          </div>

          <!-- Overall Sentiment Cards -->
          <div class="sentiment-overview" id="sentimentOverview" style="display: none;">
            <div class="sentiment-card positive-card" onclick="showSentimentDetails('positive')">
              <div class="sentiment-number" id="positiveCount">0</div>
              <div class="sentiment-label">Positive</div>
            </div>
            <div class="sentiment-card neutral-card" onclick="showSentimentDetails('neutral')">
              <div class="sentiment-number" id="neutralCount">0</div>
              <div class="sentiment-label">Neutral</div>
            </div>
            <div class="sentiment-card negative-card" onclick="showSentimentDetails('negative')">
              <div class="sentiment-number" id="negativeCount">0</div>
              <div class="sentiment-label">Negative</div>
            </div>
          </div>

          <!-- Charts Container -->
          <div class="sentiment-charts" id="sentimentCharts" style="display: none;">
            <!-- Daily Sentiment Chart -->
            <div class="chart-container">
              <h3 class="chart-title">Daily Sentiment Trends</h3>
              <div class="chart-area" id="dailySentimentChart">
                <canvas id="dailyChart" width="800" height="300"></canvas>
              </div>
            </div>

            <!-- User Sentiment Chart -->
            <div class="chart-container">
              <h3 class="chart-title">Sentiment by User</h3>
              <div class="chart-area" id="userSentimentChart">
                <canvas id="userChart" width="800" height="400"></canvas>
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div class="sentiment-loading" id="sentimentLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Analyzing sentiment patterns...</p>
          </div>

          <!-- Empty State -->
          <div class="sentiment-empty" id="sentimentEmpty">
            <i class="fas fa-heart-broken"></i>
            <h3>Ready to Analyze</h3>
            <p>Select a date range and click "Analyze Sentiment" to discover emotional patterns in your conversations.</p>
          </div>
        </div>

        <!-- Negative Messages Modal -->
        <div class="modal-overlay" id="negativeModal" style="display: none;">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">
                <i class="fas fa-frown"></i>
                Negative Messages
              </h3>
              <button class="modal-close" onclick="closeNegativeModal()">&times;</button>
            </div>
            <div class="modal-body" id="negativeMessagesList">
              <!-- Messages will be populated here -->
            </div>
          </div>
        </div>

        <!-- Q&A Help Modal -->
        <div class="modal-overlay" id="qaModal" style="display: none;">
          <div class="modal-content large-modal">
            <div class="modal-header">
              <h3 class="modal-title">
                <i class="fas fa-question-circle"></i>
                Ask Questions About Your Chat Data
              </h3>
              <button class="modal-close" onclick="closeQAModal()">&times;</button>
            </div>
            <div class="modal-body">
              <!-- Question Input Section -->
              <div class="qa-input-section">
                <div class="question-input-container">
                  <input type="text" id="questionInput" placeholder="Ask a question about your chat data..." class="question-input">
                  <button id="askQuestionBtn" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Ask
                  </button>
                </div>
                <div class="quick-questions">
                  <p><strong>Quick Questions:</strong></p>
                  <div class="quick-question-chips">
                    <span class="quick-chip" onclick="askQuickQuestion('Who is the most active user?')">Who is the most active user?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('What is the busiest day of the week?')">What is the busiest day of the week?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('What time are most messages sent?')">What time are most messages sent?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('How many messages were sent this week?')">How many messages were sent this week?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('Show me the top 5 users')">Show me the top 5 users</span>
                    <span class="quick-chip" onclick="askQuickQuestion('What are the most active hours?')">What are the most active hours?</span>
                  </div>
                </div>
              </div>

              <!-- Answer Display Section -->
              <div class="qa-answer-section" id="qaAnswerSection" style="display: none;">
                <div class="answer-container">
                  <div class="answer-header">
                    <i class="fas fa-robot"></i>
                    <span>Answer:</span>
                  </div>
                  <div class="answer-content" id="qaAnswerContent">
                    <!-- Answer will be displayed here -->
                  </div>
                </div>
              </div>

              <!-- Loading State -->
              <div class="qa-loading" id="qaLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Analyzing your question...</p>
              </div>

              <!-- Help Section -->
              <div class="qa-help-section">
                <h4><i class="fas fa-lightbulb"></i> How to Ask Questions</h4>
                <div class="help-tips">
                  <div class="help-tip">
                    <strong>User Questions:</strong> "Who is the most active user?", "Show me user activity for John"
                  </div>
                  <div class="help-tip">
                    <strong>Time Questions:</strong> "What's the busiest day?", "When are most messages sent?"
                  </div>
                  <div class="help-tip">
                    <strong>Activity Questions:</strong> "How many messages this week?", "Show me the leaderboard"
                  </div>
                  <div class="help-tip">
                    <strong>Data Questions:</strong> "What's the total message count?", "Show me weekly breakdown"
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Section -->
      <div class="section-content" id="activity-section">
        <div class="activity-dashboard">
          <!-- Header -->
          <div class="activity-header">
            <h2 class="activity-title">
              <i class="fas fa-chart-line activity-icon"></i>
              Activity Analysis
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Activity Analysis</h4>
                  <p>Views engagement patterns, peak times, and user activity in your group.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Shows daily and hourly activity patterns</li>
                    <li>Displays user engagement and message counts</li>
                    <li>Identifies peak activity times and trends</li>
                  </ul>
                  <p><strong>Input:</strong> Select date range and click "Analyze Activity"</p>
                </div>
              </div>
            </h2>
            <div class="activity-divider"></div>
          </div>

          <!-- Controls -->
          <div class="activity-controls">
            <div class="date-controls-row">
              <div class="date-input-group">
                <label class="date-label">Start Date</label>
                <input type="date" class="activity-date-input" id="activityStartDate">
              </div>
              <div class="date-input-group">
                <label class="date-label">End Date</label>
                <input type="date" class="activity-date-input" id="activityEndDate">
              </div>
            </div>
            <div class="activity-actions">
              <button class="activity-analyze-btn" id="analyzeActivity">
                <i class="fas fa-chart-area"></i>
                Analyze Activity
              </button>
            </div>
          </div>

          <!-- Quick Insights -->
          <div class="quick-insights" id="quickInsights" style="display: none;">
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-calendar-day"></i></div>
              <div class="insight-content">
                <div class="insight-title">Most Active Day</div>
                <div class="insight-value" id="mostActiveDay">-</div>
              </div>
            </div>
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-clock"></i></div>
              <div class="insight-content">
                <div class="insight-title">Peak Hour</div>
                <div class="insight-value" id="peakHour">-</div>
              </div>
            </div>
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-comments"></i></div>
              <div class="insight-content">
                <div class="insight-title">Total Messages</div>
                <div class="insight-value" id="totalMessages">-</div>
              </div>
            </div>
            <div class="insight-card">
              <div class="insight-icon"><i class="fas fa-user-crown"></i></div>
              <div class="insight-content">
                <div class="insight-title">Most Active User</div>
                <div class="insight-value" id="mostActiveUser">-</div>
              </div>
            </div>
          </div>

          <!-- Week Cards for >7 days range -->
          <div class="week-navigation" id="weekNavigation" style="display: none;">
            <h3 class="section-title">Select Week to Analyze</h3>
            <div class="week-cards" id="weekCards">
              <!-- Week cards will be dynamically generated -->
            </div>
          </div>

          <!-- Analysis View -->
          <div class="analysis-view" id="analysisView" style="display: none;">
            <!-- Period Header -->
            <div class="period-header">
              <h3 class="period-title" id="periodTitle">Weekly Analysis</h3>
              <div class="period-actions">
                <button class="btn-secondary" id="backToWeeks" style="display: none;">
                  <i class="fas fa-arrow-left"></i>
                  Back to Weeks
                </button>
              </div>
            </div>

            <!-- User Filter -->
            <div class="user-filter-section">
              <label class="form-label">Filter by User</label>
              <select class="form-select" id="userFilter">
                <option value="">All Users</option>
                <!-- Users will be populated dynamically -->
              </select>
            </div>

            <!-- Q&A Section -->
            <div class="qa-section-permanent">
              <div class="qa-header">
                <h4><i class="fas fa-question-circle"></i> Ask Questions About Your Chat Data</h4>
              </div>
              <div class="qa-input-container">
                <input type="text" id="permanentQuestionInput" placeholder="Ask a question about your chat data..." class="qa-input">
                <button id="permanentAskBtn" class="btn btn-primary">
                  <i class="fas fa-paper-plane"></i>
                  Send
                </button>
              </div>
              <div class="quick-questions-permanent">
                <div class="quick-question-chips">
                  <span class="quick-chip" onclick="askPermanentQuestion('Who is the most active user?')">Who is the most active user?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('What is the busiest day?')">What is the busiest day?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('What time are most messages sent?')">What time are most messages sent?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('How many messages this week?')">How many messages this week?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('Who messages less often?')">Who messages less often?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('Show me weekly analysis')">Show me weekly analysis</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('What do the charts show?')">What do the charts show?</span>
                  <span class="quick-chip" onclick="askPermanentQuestion('Show me the leaderboard')">Show me the leaderboard</span>
                </div>
              </div>
              <div class="qa-answer-display" id="permanentAnswerDisplay" style="display: none;">
                <div class="answer-content">
                  <div class="answer-header">
                    <i class="fas fa-robot"></i>
                    <span>Answer:</span>
                  </div>
                  <div class="answer-text" id="permanentAnswerText"></div>
                </div>
              </div>
            </div>

            <!-- Charts Container -->
            <div class="charts-grid">
              <!-- Activity by Hour -->
              <div class="chart-container">
                <div class="chart-header">
                  <h4 class="chart-title">
                    <i class="fas fa-clock"></i>
                    Activity by Hour
                  </h4>
                  <div class="chart-actions">
                    <button class="chart-zoom-btn" id="zoomHourly">
                      <i class="fas fa-search-plus"></i>
                    </button>
                  </div>
                </div>
                <div class="chart-area">
                  <canvas id="hourlyChart" width="800" height="300"></canvas>
                </div>
              </div>

              <!-- Activity by Day -->
              <div class="chart-container">
                <div class="chart-header">
                  <h4 class="chart-title">
                    <i class="fas fa-calendar-week"></i>
                    Activity by Day
                  </h4>
                  <div class="chart-actions">
                    <button class="chart-zoom-btn" id="zoomDaily">
                      <i class="fas fa-search-plus"></i>
                    </button>
                  </div>
                </div>
                <div class="chart-area">
                  <canvas id="activityDailyChart" width="800" height="300"></canvas>
                </div>
              </div>

              <!-- User Activity Distribution -->
              <div class="chart-container">
                <div class="chart-header">
                  <h4 class="chart-title">
                    <i class="fas fa-users"></i>
                    User Activity Distribution
                  </h4>
                </div>
                <div class="chart-area">
                  <canvas id="userDistributionChart" width="400" height="400"></canvas>
                </div>
              </div>
            </div>

            <!-- Top Users Leaderboard -->
            <div class="leaderboard-container">
              <div class="leaderboard-header">
                <h4 class="leaderboard-title">
                  <i class="fas fa-trophy"></i>
                  Top Active Users
                </h4>
              </div>
              <div class="leaderboard" id="userLeaderboard">
                <!-- Leaderboard items will be populated dynamically -->
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div class="activity-loading" id="activityLoading" style="display: none;">
            <div class="loading-spinner"></div>
            <p id="loadingText">Analyzing activity patterns...</p>
            <div class="progress-bar" id="progressBar" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; margin-top: 10px;">
              <div class="progress-fill" id="progressFill" style="width: 0%; height: 100%; background: var(--primary); border-radius: 2px; transition: width 0.3s ease;"></div>
            </div>
          </div>

          <!-- Empty State -->
          <div class="activity-empty" id="activityEmpty">
            <i class="fas fa-chart-line"></i>
            <h3>Ready to Analyze Activity</h3>
            <p>Select a date range and click "Analyze Activity" to discover usage patterns, peak times, and user engagement insights.</p>
          </div>
        </div>
      </div>

      <!-- Topics Section -->
      <div class="section-content" id="topics-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-tags"></i>
              Topic Analysis
            </h3>
          </div>
          <div class="date-range">
            <div class="form-group">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-input" id="topicsStartDate">
            </div>
            <div class="form-group">
              <label class="form-label">End Date</label>
              <input type="date" class="form-input" id="topicsEndDate">
            </div>
          </div>
          <button class="btn btn-primary" id="analyzeTopics">
            <i class="fas fa-brain"></i>
            Extract Topics
          </button>
          <div class="result-area" id="topicsResult">
            <div class="empty-state">
              <i class="fas fa-cloud"></i>
              <p>Identify and visualize the main topics discussed in your conversations</p>
            </div>
          </div>
        </div>
      </div>

      <!-- History Section -->
      <div class="section-content" id="history-section">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-history"></i>
              Analysis History
              <div class="tooltip">
                <span class="tooltip-icon">!</span>
                <div class="tooltip-content">
                  <h4>Analysis History</h4>
                  <p>Reviews your previous analyses and results for easy access.</p>
                  <p><strong>How it works:</strong></p>
                  <ul>
                    <li>Stores all your previous analysis results</li>
                    <li>Shows timestamps and analysis types</li>
                    <li>Allows you to clear history when needed</li>
                  </ul>
                  <p><strong>Input:</strong> Automatically tracks all your analyses</p>
                </div>
              </div>
            </h3>
            <button class="btn btn-secondary" id="clearHistory">
              <i class="fas fa-trash"></i>
              Clear History
            </button>
          </div>
          <div class="result-area" id="historyList">
            <div class="empty-state">
              <i class="fas fa-clock"></i>
              <p>Your analysis history will appear here</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Modern Analytics Dashboard JavaScript
    (function() {
      // Global state
      let currentGroup = '';
      let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
      let sentimentData = null;
      let activityData = null;
      let dailyChart = null;
      let userChart = null;
      let activityCharts = {};

      // Section metadata
      const sectionMeta = {
        summary: { title: 'Generate Summary', subtitle: 'Create comprehensive summaries of your chat conversations' },
        questions: { title: 'Ask Questions', subtitle: 'Get AI-powered insights from your chat data' },
        events: { title: 'Group Events Analysis', subtitle: 'Track member changes and group activities' },
        sentiment: { title: 'Sentiment Analysis', subtitle: 'Discover emotional patterns in conversations' },
        activity: { title: 'Activity Analysis', subtitle: 'View engagement patterns and peak times' },
        topics: { title: 'Topic Analysis', subtitle: 'Identify main discussion topics and themes' },
        history: { title: 'Analysis History', subtitle: 'Review your previous analyses and results' }
      };

      // Initialize the dashboard when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing dashboard...');
        initDashboard();
      });

      // Main initialization function
      function initDashboard() {
        console.log('initDashboard called');
        // Get group from URL parameters
        const params = new URLSearchParams(window.location.search);
        const group = params.get('group');
        const groupNameText = document.getElementById('groupNameText');
        console.log('Group from URL:', group);
        console.log('Group name text element:', groupNameText);
        
        // Set group name or load groups for selection
        if (group) {
          console.log('Setting group from URL:', group);
          groupNameText.textContent = group;
          currentGroup = group; // Set the global variable
          console.log('Current group set to:', currentGroup);
        } else {
          // Load available groups and show selection
          console.log('No group in URL, loading groups...');
          loadGroupsForSelection();
          
          // Fallback: if groups loading fails, try to use the known group
          setTimeout(() => {
            if (groupNameText.textContent === 'Loading...' || groupNameText.innerHTML.includes('spinner')) {
              console.log('Groups loading failed, using fallback group...');
              currentGroup = 'Whatsapp Chat With Sahyadri Arra15 Gr 1 2019';
              groupNameText.textContent = currentGroup;
              groupNameText.style.color = '';
              groupNameText.onclick = null;
              console.log('Fallback group set to:', currentGroup);
            }
          }, 3000);
        }

        // Initialize sidebar and navigation
        initSidebar();
        
        // Initialize all section functionality
        initSummarySection();
        initQuestionsSection();
        initEventsSection();
        initSentimentSection();
        initActivitySection();
        initTopicsSection();
        initHistorySection();
        
        // Set default dates with a small delay to ensure DOM is ready
        setTimeout(() => {
        setDefaultDates();
        }, 100);
      }

      // Load groups for selection when no group is provided
      async function loadGroupsForSelection() {
        const groupNameText = document.getElementById('groupNameText');
        
        try {
          console.log('Loading groups...');
          groupNameText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading groups...';
          
          // Add timeout to prevent infinite loading
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
          
          const response = await fetch('/groups/', {
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          console.log('Groups response:', response);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          console.log('Groups data:', data);
          const groups = data.groups || [];
          
          if (groups.length === 0) {
            console.log('No groups found');
            groupNameText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> No groups available';
            groupNameText.style.color = 'var(--error)';
            showGroupSelectionModal();
          } else if (groups.length === 1) {
            // Auto-select if only one group
            console.log('Auto-selecting single group:', groups[0]);
            currentGroup = groups[0];
            groupNameText.textContent = groups[0];
            groupNameText.style.color = '';
            groupNameText.onclick = null;
          } else {
            // Show group selection
            console.log('Multiple groups found, showing selection');
            groupNameText.innerHTML = '<i class="fas fa-users"></i> Select Group';
            groupNameText.style.color = 'var(--primary)';
            groupNameText.style.cursor = 'pointer';
            groupNameText.onclick = () => showGroupSelectionModal();
            showGroupSelectionModal(groups);
          }
        } catch (error) {
          console.error('Error loading groups:', error);
          if (error.name === 'AbortError') {
            groupNameText.innerHTML = '<i class="fas fa-clock"></i> Request timed out - Click to retry';
          } else {
            groupNameText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error loading groups - Click to retry';
          }
          groupNameText.style.color = 'var(--error)';
          groupNameText.style.cursor = 'pointer';
          groupNameText.onclick = () => loadGroupsForSelection();
        }
      }

      // Show group selection modal
      function showGroupSelectionModal(groups = null) {
        // Create modal if it doesn't exist
        let modal = document.getElementById('groupSelectionModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'groupSelectionModal';
          modal.className = 'modal';
          modal.innerHTML = `
            <div class="modal-content">
              <div class="modal-header">
                <h3><i class="fas fa-users"></i> Select Group</h3>
                <button class="modal-close" onclick="closeGroupSelectionModal()">&times;</button>
              </div>
              <div class="modal-body">
                <div id="groupList"></div>
                <div class="modal-actions">
                  <button class="btn btn-secondary" onclick="closeGroupSelectionModal()">Cancel</button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }
        
        // Load groups if not provided
        if (!groups) {
          loadGroupsForModal();
        } else {
          populateGroupList(groups);
        }
        
        modal.style.display = 'flex';
      }

      // Load groups for modal
      async function loadGroupsForModal() {
        const groupList = document.getElementById('groupList');
        groupList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading groups...</div>';
        
        try {
          const response = await fetch('/groups/');
          const data = await response.json();
          const groups = data.groups || [];
          populateGroupList(groups);
        } catch (error) {
          groupList.innerHTML = '<div class="error">Error loading groups. Please try again.</div>';
        }
      }

      // Populate group list
      function populateGroupList(groups) {
        const groupList = document.getElementById('groupList');
        
        if (groups.length === 0) {
          groupList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-users"></i>
              <p>No groups available. Please upload a chat file first.</p>
              <a href="/home" class="btn btn-primary">Go to Upload</a>
            </div>
          `;
        } else {
          groupList.innerHTML = groups.map(group => `
            <div class="group-item" onclick="selectGroup('${group}')">
              <i class="fas fa-users"></i>
              <span>${group}</span>
            </div>
          `).join('');
        }
      }

      // Select group
      function selectGroup(group) {
        currentGroup = group;
        const groupNameText = document.getElementById('groupNameText');
        groupNameText.textContent = group;
        groupNameText.style.color = '';
        groupNameText.style.cursor = 'default';
        groupNameText.onclick = null;
        closeGroupSelectionModal();
      }

      // Close group selection modal
      function closeGroupSelectionModal() {
        const modal = document.getElementById('groupSelectionModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // Initialize sidebar and navigation
      function initSidebar() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const navLinks = document.querySelectorAll('.nav-link');
        const sectionContents = document.querySelectorAll('.section-content');
        const pageTitle = document.getElementById('pageTitle');
        const pageSubtitle = document.getElementById('pageSubtitle');

        // Sidebar toggle
        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
          });
        }

        // Section navigation
        navLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.getAttribute('data-section');
            
            // Update active state
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            
            // Show corresponding section
            sectionContents.forEach(section => {
              section.classList.remove('active');
              if (section.id === `${sectionId}-section`) {
                section.classList.add('active');
              }
            });
            
            // Update page title and subtitle
            if (sectionMeta[sectionId]) {
              pageTitle.textContent = sectionMeta[sectionId].title;
              pageSubtitle.textContent = sectionMeta[sectionId].subtitle;
            }
          });
        });
      }

      // Initialize Summary Section
      function initSummarySection() {
        // Summary button event listeners
        document.getElementById('generateWeeklySummary')?.addEventListener('click', generateWeeklySummary);
        document.getElementById('generateBriefSummary')?.addEventListener('click', generateBriefSummary);
        document.getElementById('generateDailyUserMessages')?.addEventListener('click', generateDailyUserMessages);
        document.getElementById('showUserWiseOptions')?.addEventListener('click', showUserWiseOptions);
        document.getElementById('generateUserWiseReport')?.addEventListener('click', generateUserWiseReport);

        // Main button switching functionality
        document.querySelectorAll('.summary-main-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            // Update button states
            document.querySelectorAll('.summary-main-btn').forEach(b => {
              b.classList.remove('btn-primary');
              b.classList.add('btn-secondary');
            });
            this.classList.remove('btn-secondary');
            this.classList.add('btn-primary');
            
            // Hide all sub-sections
            document.querySelectorAll('.summary-sub-section').forEach(section => {
              section.style.display = 'none';
            });
            
            // Show selected sub-section
            const targetId = this.getAttribute('data-target');
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
              targetSection.style.display = 'block';
            }
          });
        });
      }

      // Initialize Questions Section
      function initQuestionsSection() {
        document.getElementById('askQuestion')?.addEventListener('click', askQuestion);
      }

      // Initialize Events Section
      function initEventsSection() {
        document.getElementById('analyzeEvents')?.addEventListener('click', analyzeEvents);
        initializeEventsDates();
      }

      // Initialize Events dates
      function initializeEventsDates() {
        const startDateInput = document.getElementById('eventsStartDate');
        const endDateInput = document.getElementById('eventsEndDate');
        
        if (startDateInput && endDateInput) {
          // Set default dates to 2024 range that contains data
          startDateInput.value = '2024-06-01';
          endDateInput.value = '2024-12-31';
        }
      }

      // Initialize Sentiment Section
      function initSentimentSection() {
        document.getElementById('analyzeSentiment')?.addEventListener('click', analyzeSentiment);
        initializeSentimentDates();
      }

      // Initialize Activity Section
      function initActivitySection() {
        document.getElementById('analyzeActivity')?.addEventListener('click', analyzeActivity);
        document.getElementById('backToWeeks')?.addEventListener('click', goBackToWeeks);
        document.getElementById('userFilter')?.addEventListener('change', handleUserFilterChange);
        
        // Initialize permanent Q&A functionality
        initializePermanentQA();
        
        // Initialize activity dates with a delay to ensure DOM is ready
        setTimeout(() => {
        initializeActivityDates();
        }, 200);
      }

      // Initialize Topics Section
      function initTopicsSection() {
        document.getElementById('analyzeTopics')?.addEventListener('click', analyzeTopics);
      }

      // Initialize History Section
      function initHistorySection() {
        document.getElementById('clearHistory')?.addEventListener('click', clearHistory);
        updateHistoryDisplay();
      }

      // Set default dates for all date inputs
      function setDefaultDates() {
        // Set default dates to a range that contains actual chat data (2020-2025)
        // Use a range that's likely to have data
        const startDate = new Date('2024-06-01'); // Mid-2024 should have data
        const endDate = new Date('2024-12-31');
        const formattedDate = (date) => date.toISOString().split('T')[0];
        
        console.log('Setting default dates:', formattedDate(startDate), 'to', formattedDate(endDate));
        
        // Set default dates for all date inputs
        document.querySelectorAll('input[type="date"]').forEach(input => {
          if (!input.value) {
            if (input.id.includes('Start')) {
              input.value = formattedDate(startDate);
            } else if (input.id.includes('End')) {
              input.value = formattedDate(endDate);
            }
          }
        });
      }

      // Initialize sentiment dates with default range (last 30 days)
      function initializeSentimentDates() {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        document.getElementById('sentimentStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('sentimentEndDate').value = today.toISOString().split('T')[0];
      }

      // Initialize activity dates with default range (last 30 days)
      function initializeActivityDates() {
        // Use the same date range as setDefaultDates to ensure consistency
        const startDate = new Date('2024-06-01'); // Mid-2024 should have data
        const endDate = new Date('2024-12-31');
        
        const startInput = document.getElementById('activityStartDate');
        const endInput = document.getElementById('activityEndDate');
        
        // Force set the values
        startInput.value = startDate.toISOString().split('T')[0];
        endInput.value = endDate.toISOString().split('T')[0];
        
        // Also set the attribute to ensure it's visible
        startInput.setAttribute('value', startDate.toISOString().split('T')[0]);
        endInput.setAttribute('value', endDate.toISOString().split('T')[0]);
      }

      // Utility functions
      function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
      }

      function showLoading(resultId) {
        const resultArea = document.getElementById(resultId);
        resultArea.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            Processing your request...
          </div>
        `;
      }

      function showError(resultId, message) {
        const resultArea = document.getElementById(resultId);
        resultArea.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle" style="color: var(--error);"></i>
            <p style="color: var(--error);">${message}</p>
          </div>
        `;
      }

      function showResult(resultId, content) {
        const resultArea = document.getElementById(resultId);
        resultArea.innerHTML = `<div style="white-space: pre-wrap; line-height: 1.6;">${content}</div>`;
      }

      function addToHistory(type, params, status = 'success', results = null) {
        const entry = {
          id: Date.now(),
          type,
          params,
          timestamp: new Date().toISOString(),
          status,
          results: results || {},
          // Store comprehensive data
          fileInfo: {
            fileName: currentGroup || 'Unknown Group',
            uploadDate: new Date().toISOString(),
            dateRange: `${params.start_date || 'N/A'} - ${params.end_date || 'N/A'}`
          },
          highlights: {
            mostActiveUser: results?.mostActiveUser || 'N/A',
            overallSentiment: results?.sentiment || { positive: 0, negative: 0, neutral: 0 },
            peakActiveTime: results?.peakTime || 'N/A',
            totalParticipants: results?.totalUsers || 0,
            totalMessages: results?.totalMessages || 0
          },
          savedResults: {
            summary: results?.summary || null,
            groupEvents: results?.groupEvents || null,
            sentimentResult: results?.sentimentData || null,
            activityAnalysis: results?.activityData || null
          }
        };
        analysisHistory.unshift(entry);
        if (analysisHistory.length > 50) analysisHistory = analysisHistory.slice(0, 50);
        localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
        updateHistoryDisplay();
      }

      function updateHistoryDisplay() {
        const historyList = document.getElementById('historyList');
        if (analysisHistory.length === 0) {
          historyList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-clock"></i>
              <p>Your analysis history will appear here</p>
            </div>
          `;
          return;
        }

        let content = '';
        analysisHistory.forEach(entry => {
          const date = new Date(entry.timestamp).toLocaleString();
          const statusIcon = entry.status === 'success' ? '✅' : '❌';
          
          // Extract highlights
          const highlights = entry.highlights || {};
          const fileInfo = entry.fileInfo || {};
          const savedResults = entry.savedResults || {};
          
          content += `
            <div class="history-item comprehensive">
              <div class="history-header">
                <div class="history-title">
                  <span class="status-icon">${statusIcon}</span>
                  <span class="analysis-type">${entry.type}</span>
                  <span class="analysis-date">${date}</span>
                </div>
                <div class="history-actions">
                  <button class="btn btn-sm btn-primary" onclick="viewFullAnalysis(${entry.id})">
                    <i class="fas fa-eye"></i> View Full
                  </button>
                  <button class="btn btn-sm btn-success" onclick="downloadReport(${entry.id})">
                    <i class="fas fa-download"></i> Export
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteHistoryEntry(${entry.id})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              
              <div class="history-content">
                <!-- File Information -->
                <div class="history-section">
                  <h4><i class="fas fa-file"></i> File Information</h4>
                  <div class="info-grid">
                    <div class="info-item">
                      <strong>File:</strong> ${fileInfo.fileName || 'Unknown'}
                    </div>
                    <div class="info-item">
                      <strong>Date Range:</strong> ${fileInfo.dateRange || 'N/A'}
                    </div>
                    <div class="info-item">
                      <strong>Participants:</strong> ${highlights.totalParticipants || 0}
                    </div>
                    <div class="info-item">
                      <strong>Messages:</strong> ${highlights.totalMessages || 0}
                    </div>
                  </div>
                </div>

                <!-- Highlights -->
                <div class="history-section">
                  <h4><i class="fas fa-star"></i> Quick Highlights</h4>
                  <div class="highlights-grid">
                    <div class="highlight-item">
                      <i class="fas fa-user"></i>
                      <span><strong>Most Active:</strong> ${highlights.mostActiveUser || 'N/A'}</span>
                    </div>
                    <div class="highlight-item">
                      <i class="fas fa-heart"></i>
                      <span><strong>Sentiment:</strong> 
                        ${highlights.overallSentiment?.positive || 0}% positive, 
                        ${highlights.overallSentiment?.negative || 0}% negative
                      </span>
                    </div>
                    <div class="highlight-item">
                      <i class="fas fa-clock"></i>
                      <span><strong>Peak Time:</strong> ${highlights.peakActiveTime || 'N/A'}</span>
                    </div>
                  </div>
                </div>

                <!-- Saved Results -->
                <div class="history-section">
                  <h4><i class="fas fa-save"></i> Saved Results</h4>
                  <div class="results-grid">
                    ${savedResults.summary ? '<div class="result-item"><i class="fas fa-file-alt"></i> Summary Available</div>' : ''}
                    ${savedResults.groupEvents ? '<div class="result-item"><i class="fas fa-calendar-alt"></i> Group Events</div>' : ''}
                    ${savedResults.sentimentResult ? '<div class="result-item"><i class="fas fa-heart"></i> Sentiment Analysis</div>' : ''}
                    ${savedResults.activityAnalysis ? '<div class="result-item"><i class="fas fa-chart-line"></i> Activity Analysis</div>' : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        historyList.innerHTML = content;
      }

      function formatDate(date) {
        return new Date(date).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      async function makeRequest(url, data, timeout = 30000) {
        console.log('Making request to:', url, 'with data:', data);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
            body: JSON.stringify(data),
            signal: controller.signal
        });
          
          clearTimeout(timeoutId);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        return await response.json();
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('Request timed out. Please try again.');
          }
          throw error;
        }
      }

      // Summary Functions
      async function generateWeeklySummary() {
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        
        if (!currentGroup) {
          showError('summaryResult', 'Please select a group first.');
          return;
        }
        
        showLoading('summaryResult');
        
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'weekly_summary',
            start_date: startDate,
            end_date: endDate
          });
          
          let content = '';
          if (data.weekly_summaries) {
            content = data.weekly_summaries.map(week => 
              `<div class="weekly-summary-item">
                <div class="weekly-summary-header">${week.date_range} (${week.message_count} messages)</div>
                <div>${week.summary}</div>
              </div>`
            ).join('');
          }
          
          document.getElementById('summaryResult').innerHTML = content || 'No weekly summaries available.';
          addToHistory('Weekly Summary', { dateRange: `${startDate} - ${endDate}` });
        } catch (error) {
          console.error('Weekly summary error:', error);
          showError('summaryResult', 'Failed to generate weekly summary. Please try again.');
        }
      }

      async function generateBriefSummary() {
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        
        if (!currentGroup) {
          showError('summaryResult', 'Please select a group first.');
          return;
        }
        
        showLoading('summaryResult');
        
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'brief',
            start_date: startDate,
            end_date: endDate
          });
          
          showResult('summaryResult', data.summary || 'No summary available.');
          addToHistory('Brief Summary', { dateRange: `${startDate} - ${endDate}` });
        } catch (error) {
          console.error('Brief summary error:', error);
          showError('summaryResult', 'Failed to generate brief summary. Please try again.');
        }
      }

      async function generateDailyUserMessages() {
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        
        if (!currentGroup) {
          showError('summaryResult', 'Please select a group first.');
          return;
        }
        
        showLoading('summaryResult');
        
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'daily_user_messages',
            start_date: startDate,
            end_date: endDate
          });
          
          let content = '';
          if (data.daily_summaries) {
            content = data.daily_summaries.map(day => 
              `<div class="daily-summary-item">
                <div class="daily-summary-date">${day.formatted_date} (${day.message_count} messages)</div>
                <div>${day.summary}</div>
              </div>`
            ).join('');
          }
          
          document.getElementById('summaryResult').innerHTML = content || 'No daily summaries available.';
          addToHistory('Daily User Messages', { dateRange: `${startDate} - ${endDate}` });
        } catch (error) {
          console.error('Daily messages error:', error);
          showError('summaryResult', 'Failed to generate daily messages. Please try again.');
        }
      }

      async function showUserWiseOptions() {
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'user_wise',
            start_date: document.getElementById('summaryStartDate').value,
            end_date: document.getElementById('summaryEndDate').value
          });
          
          const userDropdown = document.getElementById('userDropdown');
          
          // Clear existing options (keep first option)
          userDropdown.innerHTML = '<option value="">Choose a user...</option>';
          
          if (data.users) {
            data.users.forEach(user => {
              const option = new Option(user, user);
              userDropdown.appendChild(option);
            });
          }
          
          document.getElementById('userSelectionArea').style.display = 'block';
        } catch (error) {
          console.error('Error loading users:', error);
          showError('summaryResult', 'Failed to load users. Please try again.');
        }
      }

      async function generateUserWiseReport() {
        const selectedUser = document.getElementById('userDropdown').value;
        const startDate = document.getElementById('summaryStartDate').value;
        const endDate = document.getElementById('summaryEndDate').value;
        
        if (!selectedUser) {
          showError('summaryResult', 'Please select a user first.');
          return;
        }
        
        showLoading('summaryResult');
        
        try {
          const data = await makeRequest('/summarize/', {
            group_name: currentGroup,
            summary_type: 'user_wise_detailed',
            user: selectedUser,
            start_date: startDate,
            end_date: endDate
          });
          
          let content = `<h4>Messages from ${selectedUser}</h4>`;
          if (data.user_messages) {
            content += data.user_messages.map(msg => 
              `<div class="user-message-item">
                <div class="message-datetime">${msg.datetime}</div>
                <div class="message-text">${msg.message}</div>
              </div>`
            ).join('');
          }
          
          document.getElementById('summaryResult').innerHTML = content;
          addToHistory('User-wise Report', { user: selectedUser, dateRange: `${startDate} - ${endDate}` });
        } catch (error) {
          console.error('User-wise report error:', error);
          showError('summaryResult', 'Failed to generate user-wise report. Please try again.');
        }
      }

      // Questions Function
      async function askQuestion() {
        const question = document.getElementById('userQuestion').value.trim();
        const startDate = document.getElementById('questionStartDate').value;
        const endDate = document.getElementById('questionEndDate').value;
        
        if (!question) {
          showError('questionResult', 'Please enter a question first.');
          return;
        }
        
        if (!currentGroup) {
          showError('questionResult', 'Please select a group first.');
          return;
        }
        
        showLoading('questionResult');
        
        try {
          const data = await makeRequest('/ask/', {
            group_name: currentGroup,
            question: question,
            start_date: startDate,
            end_date: endDate
          });
          
          showResult('questionResult', data.answer || 'No answer received');
          addToHistory('Ask Questions', { question: question.substring(0, 50) + '...', start_date: 'N/A', end_date: 'N/A' }, 'success', {
            answer: data.answer
          });
        } catch (error) {
          console.error('Question error:', error);
          showError('questionResult', 'Failed to get answer. Please try again.');
        }
      }

      // Events Function
      async function analyzeEvents() {
        const startDate = document.getElementById('eventsStartDate').value;
        const endDate = document.getElementById('eventsEndDate').value;
        
        console.log('Analyzing events for group:', currentGroup);
        console.log('Date range:', startDate, 'to', endDate);
        
        if (!currentGroup) {
          showError('eventsResult', 'Please select a group first.');
          return;
        }
        
        showLoading('eventsResult');
        
        try {
          const data = await makeRequest('/group_events/', {
            group_name: currentGroup,
            start_date: startDate,
            end_date: endDate
          });
          
          console.log('Events data received:', data);
          
          // Create modern card-based dashboard design
          let content = '';
          
          if (data.event_counts) {
            console.log('Event counts:', data.event_counts);
            
            // Debug: Show if any events were found
            const totalEvents = Object.values(data.event_counts).reduce((sum, count) => sum + count, 0);
            console.log('Total events found:', totalEvents);
            content += '<div class="events-dashboard">';
            content += '<h3 class="dashboard-title">Group Events Summary</h3>';
            content += '<div class="events-grid">';
            
            const eventTypes = [
              {
                key: 'added', 
                title: 'Added', 
                color: '#22c55e',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>`
              },
              {
                key: 'left', 
                title: 'Left', 
                color: '#ef4444',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`
              }, 
              {
                key: 'removed', 
                title: 'Removed', 
                color: '#f97316',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`
              },
              {
                key: 'changed_subject', 
                title: 'Subject Changed', 
                color: '#3b82f6',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>`
              },
              {
                key: 'changed_icon', 
                title: 'Icon Changed', 
                color: '#8b5cf6',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path></svg>`
              },
              {
                key: 'created', 
                title: 'Group Created', 
                color: '#10b981',
                icon: `<svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
              }
            ];
            
            eventTypes.forEach(event => {
              const count = data.event_counts[event.key] || 0;
              console.log(`Creating card for ${event.key}: ${count} events`);
              content += `
                <div class="event-card" style="border-left: 4px solid ${event.color}; cursor: pointer;" onclick="toggleEventDetails('${event.key}', '${event.title}', ${count}, '${event.color}')">
                  <div class="event-icon" style="background: ${event.color}20; color: ${event.color};">
                    ${event.icon}
                  </div>
                  <div class="event-info">
                    <div class="event-title">${event.title}</div>
                    <div class="event-count">${count}</div>
                    <div class="event-label">events</div>
                  </div>
                </div>
              `;
            });
            
            content += '</div>';
            
            // Add expandable details panel
            content += '<div id="eventDetailsPanel" class="event-details-panel"></div>';
            
            // Add top removers section if available
            if (data.top_removers && data.top_removers.length > 0) {
              content += '<div class="top-removers-section">';
              content += '<h4>Top Removers:</h4>';
              content += '<div class="removers-list">';
              data.top_removers.forEach((remover, i) => {
                content += `
                  <div class="remover-item">
                    <span class="remover-rank">${i + 1}.</span>
                    <span class="remover-name">${remover.user}</span>
                    <span class="remover-count">${remover.count} removals</span>
                  </div>
                `;
              });
              content += '</div></div>';
            }
            
            content += '</div>';
          } else {
            console.log('No event_counts in response');
            content = '<div class="empty-state"><i class="fas fa-info-circle"></i><p>No events found in the selected date range. Try a different date range or check if the group has any system messages.</p></div>';
          }
          
          showResult('eventsResult', content);
          addToHistory('Group Events Analysis', { start_date: startDate, end_date: endDate }, 'success', {
            groupEvents: data,
            totalEvents: Object.values(data.event_counts || {}).reduce((a, b) => a + b, 0)
          });
        } catch (error) {
          console.error('Events error:', error);
          let errorMessage = 'Failed to analyze events. Please try again.';
          if (error.message) {
            errorMessage = `Error: ${error.message}`;
          }
          showError('eventsResult', errorMessage);
        }
      }

      // Event Details Function with expandable functionality
      async function toggleEventDetails(eventType, eventTitle, count, color) {
        console.log('toggleEventDetails called:', { eventType, eventTitle, count, color });
        const panel = document.getElementById('eventDetailsPanel');
        
        if (!panel) {
          console.error('eventDetailsPanel not found!');
          return;
        }
        
        if (count === 0) {
          console.log('No events found for', eventType);
          panel.innerHTML = `
            <div class="event-details-header">
              <h4><i class="fas fa-info-circle"></i> ${eventTitle} Events</h4>
            </div>
            <div class="event-details-content">
              <div class="event-log-item">
                <div class="event-log-content">
                  <div class="event-log-details">No ${eventType.replace('_', ' ')} events found in the selected date range.</div>
                </div>
              </div>
            </div>
          `;
          panel.classList.add('show');
          return;
        }
        
        // Toggle panel visibility
        if (panel.classList.contains('show') && panel.dataset.currentEventType === eventType) {
          panel.classList.remove('show');
          return;
        }
        
        // Show loading state
        panel.innerHTML = `
          <div class="event-details-header">
            <h4>${getEventIcon(eventType, color)} ${eventTitle} Events (${count})</h4>
          </div>
          <div class="event-details-content">
            <div class="event-log-item">
              <div class="event-log-icon" style="background: var(--border); color: var(--text-muted);">
                <i class="fas fa-spinner fa-spin"></i>
              </div>
              <div class="event-log-content">
                <div class="event-log-details">Loading event details...</div>
              </div>
            </div>
          </div>
        `;
        panel.classList.add('show');
        panel.dataset.currentEventType = eventType;
        
        try {
          // Fetch detailed event logs
          const startDate = document.getElementById('eventsStartDate').value;
          const endDate = document.getElementById('eventsEndDate').value;
          
          console.log('Fetching event details for:', { group_name: currentGroup, event_type: eventType, start_date: startDate, end_date: endDate });
          
          const data = await makeRequest('/event_details/', {
            group_name: currentGroup,
            event_type: eventType,
            start_date: startDate,
            end_date: endDate
          });
          
          console.log('Event details response:', data);
          
          let content = `
            <div class="event-details-header">
              <h4>${getEventIcon(eventType, color)} ${eventTitle} Events (${data.events.length})</h4>
            </div>
            <div class="event-details-content">
          `;
          
          if (data.events.length === 0) {
            content += `
              <div class="event-log-item">
                <div class="event-log-content">
                  <div class="event-log-details">No events found in the selected date range.</div>
                </div>
              </div>
            `;
          } else {
            data.events.forEach(event => {
              const logIcon = getEventIcon(eventType, color);
              const actionText = formatEventAction(event, eventType);
              const timestamp = formatTimestamp(event.timestamp);
              
              content += `
                <div class="event-log-item">
                  <div class="event-log-icon" style="background: ${color}20; color: ${color};">
                    ${logIcon}
                  </div>
                  <div class="event-log-content">
                    <div class="event-log-action">${actionText}</div>
                    <div class="event-log-details">${event.details || event.raw_message || 'System message'}</div>
                    <div class="event-log-meta">
                      <span class="event-log-sender"><i class="fas fa-user"></i> ${event.sender || 'Unknown'}</span>
                      <span class="event-log-timestamp"><i class="fas fa-clock"></i> ${timestamp}</span>
                    </div>
                  </div>
                </div>
              `;
            });
          }
          
          content += '</div>';
          panel.innerHTML = content;
          
        } catch (error) {
          console.error('Error loading event details:', error);
          panel.innerHTML = `
            <div class="event-details-header">
              <h4><i class="fas fa-exclamation-triangle"></i> ${eventTitle} Events</h4>
            </div>
            <div class="event-details-content">
              <div class="event-log-item">
                <div class="event-log-icon" style="background: var(--error)20; color: var(--error);">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="event-log-content">
                  <div class="event-log-details">Failed to load event details. Please try again.</div>
                </div>
              </div>
            </div>
          `;
        }
      }
      
      // Helper function to get event icons
      function getEventIcon(eventType, color) {
        const icons = {
          'added': `<svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px;"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>`,
          'left': `<svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px;"><path fill-rule="evenodd" d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`,
          'removed': `<svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px;"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`,
          'changed_subject': `<svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px;"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg>`,
          'changed_icon': `<svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px;"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path></svg>`,
          'created': `<svg fill="currentColor" viewBox="0 0 20 20" style="width: 16px; height: 16px;"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
        };
        return icons[eventType] || '<i class="fas fa-circle"></i>';
      }
      
      // Helper function to format event actions
      function formatEventAction(event, eventType) {
        switch(eventType) {
          case 'added':
            return `${event.added_person || 'Someone'} was added by ${event.adder || 'someone'}`;
          case 'left':
            return `${event.person || 'Someone'} left the group`;
          case 'removed':
            return `${event.removed_person || 'Someone'} was removed by ${event.remover || 'someone'}`;
          case 'changed_subject':
            return `${event.changer || 'Someone'} changed the subject to "${event.new_subject || 'New Subject'}"`;
          case 'changed_icon':
            return `${event.changer || 'Someone'} changed the group icon`;
          case 'created':
            return `${event.creator || 'Someone'} created the group`;
          default:
            return 'Group event occurred';
        }
      }
      
      // Helper function to format timestamps
      function formatTimestamp(timestamp) {
        if (!timestamp) return 'Unknown time';
        try {
          const date = new Date(timestamp);
          if (isNaN(date.getTime())) {
            // Try parsing the timestamp as is
            return timestamp;
          }
          return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
        } catch (error) {
          return timestamp;
        }
      }

      // Sentiment Analysis Functions
      async function analyzeSentiment() {
        const startDate = document.getElementById('sentimentStartDate').value;
        const endDate = document.getElementById('sentimentEndDate').value;
        
        if (!currentGroup) {
          showSentimentError('Please select a group first. Upload a chat file and select a group from the URL.');
          return;
        }
        
        if (!startDate || !endDate) {
          showSentimentError('Please select both start and end dates.');
          return;
        }
        
        showSentimentLoading();
        
        try {
          const data = await makeRequest('/sentiment/', {
            group_name: currentGroup,
            start_date: startDate,
            end_date: endDate
          });
          
          sentimentData = data;
          displaySentimentResults(data);
          addToHistory('Sentiment Analysis', { start_date: startDate, end_date: endDate }, 'success', {
            sentimentData: data,
            sentiment: {
              positive: data.positive_percentage || 0,
              negative: data.negative_percentage || 0,
              neutral: data.neutral_percentage || 0
            }
          });
        } catch (error) {
          console.error('Sentiment error:', error);
          showSentimentError(`Failed to analyze sentiment: ${error.message}`);
        }
      }

      function showSentimentLoading() {
        document.getElementById('sentimentEmpty').style.display = 'none';
        document.getElementById('sentimentOverview').style.display = 'none';
        document.getElementById('sentimentCharts').style.display = 'none';
        document.getElementById('sentimentLoading').style.display = 'block';
      }

      function showSentimentError(message) {
        document.getElementById('sentimentLoading').style.display = 'none';
        document.getElementById('sentimentOverview').style.display = 'none';
        document.getElementById('sentimentCharts').style.display = 'none';
        document.getElementById('sentimentEmpty').style.display = 'block';
        document.getElementById('sentimentEmpty').innerHTML = `
          <i class="fas fa-exclamation-triangle" style="color: var(--error);"></i>
          <h3>Analysis Failed</h3>
          <p style="color: var(--error);">${message}</p>
        `;
      }

      function displaySentimentResults(data) {
        document.getElementById('sentimentLoading').style.display = 'none';
        document.getElementById('sentimentEmpty').style.display = 'none';
        
        // Update sentiment cards
        updateSentimentCards(data.sentiment_breakdown || {});
        
        // Show overview and charts
        document.getElementById('sentimentOverview').style.display = 'grid';
        document.getElementById('sentimentCharts').style.display = 'flex';
        
        // Create charts
        createDailySentimentChart(data.daily_sentiment || {});
        createUserSentimentChart(data.user_sentiments || {});
      }

      function updateSentimentCards(sentimentBreakdown) {
        const positive = sentimentBreakdown.positive || 0;
        const neutral = sentimentBreakdown.neutral || 0;
        const negative = sentimentBreakdown.negative || 0;
        
        document.getElementById('positiveCount').textContent = positive;
        document.getElementById('neutralCount').textContent = neutral;
        document.getElementById('negativeCount').textContent = negative;
      }

      function createDailySentimentChart(dailyData) {
        const canvas = document.getElementById('dailyChart');
        const ctx = canvas.getContext('2d');
        
        // Clear previous chart
        if (dailyChart) {
          dailyChart.destroy();
        }
        
        const dates = Object.keys(dailyData).sort();
        const positiveData = dates.map(date => dailyData[date]?.positive || 0);
        const neutralData = dates.map(date => dailyData[date]?.neutral || 0);
        const negativeData = dates.map(date => dailyData[date]?.negative || 0);
        
        dailyChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: dates.map(date => new Date(date).toLocaleDateString()),
            datasets: [{
              label: 'Positive',
              data: positiveData,
              borderColor: '#2DB46E',
              backgroundColor: 'rgba(45, 180, 110, 0.1)',
              fill: true,
              tension: 0.4
            }, {
              label: 'Neutral',
              data: neutralData,
              borderColor: '#888888',
              backgroundColor: 'rgba(136, 136, 136, 0.1)',
              fill: true,
              tension: 0.4
            }, {
              label: 'Negative',
              data: negativeData,
              borderColor: '#E04F4F',
              backgroundColor: 'rgba(224, 79, 79, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                callbacks: {
                  afterBody: function(context) {
                    return 'Sample message: "' + getSampleMessage(context[0].label, context[0].dataset.label) + '"';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            onClick: (event, elements) => {
              if (elements.length > 0 && elements[0].dataset.label === 'Negative') {
                const date = dates[elements[0].index];
                showNegativeModal(date);
              }
            }
          }
        });
      }

      function createUserSentimentChart(userSentiments) {
        const canvas = document.getElementById('userChart');
        const ctx = canvas.getContext('2d');
        
        // Clear previous chart
        if (userChart) {
          userChart.destroy();
        }
        
        const users = Object.keys(userSentiments);
        const positiveData = users.map(user => userSentiments[user]?.positive || 0);
        const neutralData = users.map(user => userSentiments[user]?.neutral || 0);
        const negativeData = users.map(user => userSentiments[user]?.negative || 0);
        
        userChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: users,
            datasets: [{
              label: 'Positive',
              data: positiveData,
              backgroundColor: '#2DB46E',
              borderRadius: 4
            }, {
              label: 'Neutral',
              data: neutralData,
              backgroundColor: '#888888',
              borderRadius: 4
            }, {
              label: 'Negative',
              data: negativeData,
              backgroundColor: '#E04F4F',
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            plugins: {
              tooltip: {
                callbacks: {
                  afterBody: function(context) {
                    return 'Sample message: "' + getSampleMessage(context[0].label, context[0].dataset.label) + '"';
                  }
                }
              }
            },
            scales: {
              x: {
                stacked: true,
                grid: {
                  display: false
                }
              },
              y: {
                stacked: true,
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.1)'
                }
              }
            },
            onClick: (event, elements) => {
              if (elements.length > 0 && elements[0].dataset.label === 'Negative') {
                const user = users[elements[0].index];
                showNegativeModal(null, user);
              }
            }
          }
        });
      }

      function getSampleMessage(dateOrUser, sentiment) {
        const sampleMessages = {
          positive: ["Great work everyone!", "Love this group!", "Thanks for sharing!"],
          neutral: ["Meeting at 3pm", "Please check the document", "What time works?"],
          negative: ["This is frustrating", "I disagree with this", "Not happy about this"]
        };
        
        const messages = sampleMessages[sentiment.toLowerCase()] || sampleMessages.neutral;
        return messages[Math.floor(Math.random() * messages.length)];
      }

      function showNegativeModal(date = null, user = null) {
        const modal = document.getElementById('negativeModal');
        const messagesList = document.getElementById('negativeMessagesList');
        
        // Generate sample negative messages
        const samples = [
          {
            user: user || "Alice",
            time: "2024-01-15 14:30",
            text: "This is really frustrating. Why does everything have to be so complicated?",
            explanation: "Contains frustration and negative emotion keywords"
          },
          {
            user: user || "Bob", 
            time: "2024-01-15 16:45",
            text: "I hate when people don't respond to important messages",
            explanation: "Uses strong negative language ('hate') and expresses dissatisfaction"
          },
          {
            user: user || "Charlie",
            time: "2024-01-16 09:20",
            text: "This decision is completely wrong and will cause problems",
            explanation: "Expresses disagreement and predicts negative outcomes"
          }
        ];
        
        messagesList.innerHTML = samples.map(msg => `
          <div class="message-item">
            <div class="message-header">
              <span class="message-user">
                <i class="fas fa-user"></i>
                ${msg.user}
              </span>
              <span class="message-time">
                <i class="fas fa-clock"></i>
                ${msg.time}
              </span>
            </div>
            <div class="message-text">${msg.text}</div>
            <div class="message-explanation">
              <strong><i class="fas fa-lightbulb"></i> Why this is negative:</strong> ${msg.explanation}
            </div>
          </div>
        `).join('');
        
        modal.style.display = 'flex';
        
        // Close on outside click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeNegativeModal();
          }
        });
      }

      window.closeNegativeModal = function() {
        document.getElementById('negativeModal').style.display = 'none';
      };

      // Q&A Modal Functions
      window.showQAModal = function() {
        console.log('showQAModal called');
        const modal = document.getElementById('qaModal');
        console.log('Modal element:', modal);
        
        if (modal) {
          console.log('Modal found, attempting to show...');
          // Force display with important
          modal.style.setProperty('display', 'flex', 'important');
          modal.style.setProperty('visibility', 'visible', 'important');
          modal.style.setProperty('opacity', '1', 'important');
          modal.style.setProperty('z-index', '9999', 'important');
          console.log('Modal styles applied');
          
          // Check if modal is actually visible
          setTimeout(() => {
            const computedStyle = window.getComputedStyle(modal);
            console.log('Modal computed display:', computedStyle.display);
            console.log('Modal computed visibility:', computedStyle.visibility);
            console.log('Modal computed opacity:', computedStyle.opacity);
            console.log('Modal computed z-index:', computedStyle.zIndex);
          }, 100);
          
          // Initialize Q&A functionality
          initializeQA();
          
          // Close on outside click
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              closeQAModal();
            }
          });
        } else {
          console.error('Q&A Modal not found');
          alert('Q&A Modal not found in DOM');
          
          // Try to create modal dynamically
          console.log('Attempting to create modal dynamically...');
          createQAModal();
        }
      };

      window.closeQAModal = function() {
        const modal = document.getElementById('qaModal');
        if (modal) {
          modal.style.display = 'none';
        }
      };

      // Initialize Q&A functionality
      function initializeQA() {
        const askBtn = document.getElementById('askQuestionBtn');
        const questionInput = document.getElementById('questionInput');
        
        if (askBtn) {
          askBtn.addEventListener('click', handleQuestion);
        }
        
        if (questionInput) {
          questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              handleQuestion();
            }
          });
        }
      }

      // Handle question asking
      async function handleQuestion() {
        const questionInput = document.getElementById('questionInput');
        const question = questionInput.value.trim();
        
        if (!question) {
          alert('Please enter a question');
          return;
        }
        
        showQALoading();
        
        try {
          const answer = await getAnswerFromData(question);
          displayQAAnswer(answer);
        } catch (error) {
          console.error('Error getting answer:', error);
          displayQAAnswer('Sorry, I encountered an error while processing your question. Please try again.');
        }
      }

      // Quick question handler
      window.askQuickQuestion = function(question) {
        const questionInput = document.getElementById('questionInput');
        questionInput.value = question;
        handleQuestion();
      };

      // Show loading state
      function showQALoading() {
        document.getElementById('qaLoading').style.display = 'block';
        document.getElementById('qaAnswerSection').style.display = 'none';
      }

      // Display answer
      function displayQAAnswer(answer) {
        document.getElementById('qaLoading').style.display = 'none';
        document.getElementById('qaAnswerContent').innerHTML = answer;
        document.getElementById('qaAnswerSection').style.display = 'block';
      }

      // Get answer from chat data
      async function getAnswerFromData(question) {
        // This function will analyze the question and provide answers based on current data
        const lowerQuestion = question.toLowerCase();
        
        // Get current activity data if available
        const currentData = getCurrentActivityData();
        
        // Check if question is related to chat analysis
        if (!isChatRelatedQuestion(lowerQuestion)) {
          return getUnrelatedQuestionAnswer(question);
        }
        
        // Handle specific question types
        if (lowerQuestion.includes('most active user') || lowerQuestion.includes('top user') || lowerQuestion.includes('who sent most')) {
          return getMostActiveUserAnswer(currentData);
        } else if (lowerQuestion.includes('busiest day') || lowerQuestion.includes('most active day') || lowerQuestion.includes('which day')) {
          return getBusiestDayAnswer(currentData);
        } else if (lowerQuestion.includes('time') && (lowerQuestion.includes('message') || lowerQuestion.includes('active'))) {
          return getPeakTimeAnswer(currentData);
        } else if (lowerQuestion.includes('how many message') || lowerQuestion.includes('total message') || lowerQuestion.includes('message count')) {
          return getMessageCountAnswer(currentData);
        } else if (lowerQuestion.includes('top 5') || lowerQuestion.includes('leaderboard') || lowerQuestion.includes('ranking')) {
          return getTopUsersAnswer(currentData);
        } else if (lowerQuestion.includes('active hour') || lowerQuestion.includes('peak hour') || lowerQuestion.includes('busiest hour')) {
          return getActiveHoursAnswer(currentData);
        } else if (lowerQuestion.includes('less active') || lowerQuestion.includes('least active') || lowerQuestion.includes('quiet')) {
          return getLeastActiveUserAnswer(currentData);
        } else if (lowerQuestion.includes('week') || lowerQuestion.includes('weekly')) {
          return getWeeklyAnalysisAnswer(currentData);
        } else if (lowerQuestion.includes('chart') || lowerQuestion.includes('graph') || lowerQuestion.includes('visualization')) {
          return getChartAnalysisAnswer(currentData);
        } else {
          return getIntelligentAnswer(question, currentData);
        }
      }

      // Check if question is related to chat analysis
      function isChatRelatedQuestion(question) {
        const chatKeywords = [
          'user', 'message', 'chat', 'activity', 'day', 'time', 'hour', 'week', 'active', 'busy', 'peak',
          'total', 'count', 'chart', 'graph', 'analysis', 'data', 'insight', 'leaderboard', 'ranking',
          'sent', 'received', 'frequency', 'pattern', 'trend', 'statistic', 'metric', 'report'
        ];
        
        return chatKeywords.some(keyword => question.includes(keyword));
      }

      // Handle unrelated questions
      function getUnrelatedQuestionAnswer(question) {
        return `I understand you're asking: "${question}". However, I'm designed to help you analyze your WhatsApp chat data. Please ask questions related to:
        <br><br>
        <strong>📊 Chat Analysis:</strong> "Who is the most active user?", "What's the busiest day?"
        <br>
        <strong>⏰ Time Patterns:</strong> "When are most messages sent?", "What's the peak hour?"
        <br>
        <strong>👥 User Activity:</strong> "Show me the leaderboard", "Who messages less often?"
        <br>
        <strong>📈 Data Insights:</strong> "How many messages this week?", "What do the charts show?"
        <br><br>
        Try asking something like: "Who is the most active user?" or "What is the busiest day?"`;
      }

      // Get current activity data
      function getCurrentActivityData() {
        // Try to get data from current analysis
        const quickInsights = document.getElementById('quickInsights');
        if (quickInsights && quickInsights.style.display !== 'none') {
          // Extract data from visible elements
          return {
            hasData: true,
            period: document.getElementById('periodTitle')?.textContent || 'Current Period'
          };
        }
        return { hasData: false };
      }

      // Answer generators
      function getMostActiveUserAnswer(data) {
        if (!data.hasData) {
          return 'Please analyze some activity data first to see the most active user. Click "Analyze Activity" to get started.';
        }
        
        // Try to get data from the current analysis
        const mostActiveUserElement = document.querySelector('.insight-card:nth-child(4) .insight-value');
        if (mostActiveUserElement && mostActiveUserElement.textContent !== 'N/A') {
          return `The most active user is: <strong>${mostActiveUserElement.textContent}</strong>`;
        }
        
        return 'Most active user information will be available after analyzing a week with data.';
      }

      function getBusiestDayAnswer(data) {
        if (!data.hasData) {
          return 'Please analyze some activity data first to see the busiest day. Click "Analyze Activity" to get started.';
        }
        
        const mostActiveDayElement = document.querySelector('.insight-card:nth-child(1) .insight-value');
        if (mostActiveDayElement && mostActiveDayElement.textContent !== 'N/A') {
          return `The busiest day is: <strong>${mostActiveDayElement.textContent}</strong>`;
        }
        
        return 'Busiest day information will be available after analyzing a week with data.';
      }

      function getPeakTimeAnswer(data) {
        if (!data.hasData) {
          return 'Please analyze some activity data first to see peak messaging times. Click "Analyze Activity" to get started.';
        }
        
        const peakHourElement = document.querySelector('.insight-card:nth-child(2) .insight-value');
        if (peakHourElement && peakHourElement.textContent !== 'N/A') {
          return `Peak messaging time is: <strong>${peakHourElement.textContent}</strong>`;
        }
        
        return 'Peak time information will be available after analyzing a week with data.';
      }

      function getMessageCountAnswer(data) {
        if (!data.hasData) {
          return 'Please analyze some activity data first to see message counts. Click "Analyze Activity" to get started.';
        }
        
        const totalMessagesElement = document.querySelector('.insight-card:nth-child(3) .insight-value');
        if (totalMessagesElement && totalMessagesElement.textContent !== 'N/A') {
          return `Total messages: <strong>${totalMessagesElement.textContent}</strong>`;
        }
        
        return 'Message count information will be available after analyzing a week with data.';
      }

      function getTopUsersAnswer(data) {
        if (!data.hasData) {
          return 'Please analyze some activity data first to see the top users. Click "Analyze Activity" to get started.';
        }
        
        return 'Check the "Top Active Users" chart below to see the leaderboard of most active users.';
      }

      function getActiveHoursAnswer(data) {
        if (!data.hasData) {
          return 'Please analyze some activity data first to see active hours. Click "Analyze Activity" to get started.';
        }
        
        return 'Check the "Activity by Hour" chart below to see which hours are most active for messaging.';
      }

      // New answer functions for better question handling
      function getLeastActiveUserAnswer(data) {
        if (!data.hasData) {
          return 'Please analyze some activity data first to see the least active user. Click "Analyze Activity" to get started.';
        }
        
        // Try to get data from the leaderboard or charts
        const leaderboardItems = document.querySelectorAll('.leaderboard-item');
        if (leaderboardItems.length > 0) {
          const lastItem = leaderboardItems[leaderboardItems.length - 1];
          const userName = lastItem.querySelector('.user-name')?.textContent;
          const messageCount = lastItem.querySelector('.message-count')?.textContent;
          
          if (userName && messageCount) {
            return `The least active user is: <strong>${userName}</strong> with <strong>${messageCount}</strong> messages. Check the "Top Active Users" chart below to see the complete ranking.`;
          }
        }
        
        return 'Check the "Top Active Users" chart below to see who is the least active user.';
      }

      function getWeeklyAnalysisAnswer(data) {
        if (!data.hasData) {
          return 'Please analyze some activity data first to see weekly analysis. Click "Analyze Activity" to get started.';
        }
        
        const periodTitle = document.getElementById('periodTitle')?.textContent;
        const totalMessages = document.querySelector('.insight-card:nth-child(3) .insight-value')?.textContent;
        const totalUsers = document.querySelector('.insight-card:nth-child(3) .insight-value')?.textContent;
        
        let answer = `Weekly Analysis for <strong>${periodTitle || 'Current Week'}</strong>:<br><br>`;
        
        if (totalMessages && totalMessages !== 'N/A') {
          answer += `📊 <strong>Total Messages:</strong> ${totalMessages}<br>`;
        }
        
        answer += `📈 <strong>Charts Available:</strong><br>`;
        answer += `• Activity by Hour - Shows when messages are sent<br>`;
        answer += `• Activity by Day - Shows which days are busiest<br>`;
        answer += `• User Activity Distribution - Shows user participation<br>`;
        answer += `• Top Active Users - Shows user rankings<br><br>`;
        answer += `Click on different weeks above to compare weekly patterns!`;
        
        return answer;
      }

      function getChartAnalysisAnswer(data) {
        if (!data.hasData) {
          return 'Please analyze some activity data first to see chart analysis. Click "Analyze Activity" to get started.';
        }
        
        return `Here's what the charts show:<br><br>
        <strong>📊 Activity by Hour:</strong> Shows peak messaging times throughout the day<br>
        <strong>📅 Activity by Day:</strong> Shows which days of the week are most active<br>
        <strong>👥 User Activity Distribution:</strong> Shows how active each user is<br>
        <strong>🏆 Top Active Users:</strong> Ranks users by message count<br><br>
        The charts are interactive - hover over them to see specific values!`;
      }

      function getIntelligentAnswer(question, data) {
        if (!data.hasData) {
          return `I understand you're asking: "${question}". To provide accurate answers about your chat data, please first run the Activity Analysis by clicking "Analyze Activity" and selecting a week with data. Then I can give you specific insights about your chat patterns, user activity, and messaging trends.`;
        }
        
        // Try to extract key information from the question
        const lowerQuestion = question.toLowerCase();
        
        if (lowerQuestion.includes('who') || lowerQuestion.includes('user')) {
          return `Based on your question about users, check the "Top Active Users" chart below to see user rankings and activity levels. You can also use the user filter above to focus on specific users.`;
        } else if (lowerQuestion.includes('when') || lowerQuestion.includes('time')) {
          return `For time-related questions, check the "Activity by Hour" chart below to see when most messages are sent throughout the day.`;
        } else if (lowerQuestion.includes('day') || lowerQuestion.includes('week')) {
          return `For day-related questions, check the "Activity by Day" chart below to see which days are most active.`;
        } else if (lowerQuestion.includes('how many') || lowerQuestion.includes('count') || lowerQuestion.includes('number')) {
          return `For count-related questions, check the quick insights above and the charts below for specific numbers and statistics.`;
        } else {
          return `I understand you're asking: "${question}". Based on your current analysis, you can find detailed information in the charts and insights displayed below. For specific data, try asking more specific questions like "Who is the most active user?" or "What is the busiest day?"`;
        }
      }

      function getGeneralAnswer(question, data) {
        if (!data.hasData) {
          return `I understand you're asking: "${question}". To provide accurate answers about your chat data, please first run the Activity Analysis by clicking "Analyze Activity" and selecting a week with data. Then I can give you specific insights about your chat patterns, user activity, and messaging trends.`;
        }
        
        return `I understand you're asking: "${question}". Based on your current analysis, you can find detailed information in the charts and insights displayed below. For specific data, try asking more specific questions like "Who is the most active user?" or "What is the busiest day?"`;
      }

      // Go back to weeks function
      function goBackToWeeks() {
        document.getElementById('analysisView').style.display = 'none';
        document.getElementById('weekNavigation').style.display = 'block';
        document.getElementById('backToWeeks').style.display = 'none';
      }

      // Make goBackToWeeks globally available
      window.goBackToWeeks = goBackToWeeks;

      // Initialize permanent Q&A functionality
      function initializePermanentQA() {
        const askBtn = document.getElementById('permanentAskBtn');
        const questionInput = document.getElementById('permanentQuestionInput');
        
        if (askBtn) {
          askBtn.addEventListener('click', handlePermanentQuestion);
        }
        
        if (questionInput) {
          questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              handlePermanentQuestion();
            }
          });
        }
      }

      // Handle permanent question asking
      async function handlePermanentQuestion() {
        const questionInput = document.getElementById('permanentQuestionInput');
        const question = questionInput.value.trim();
        
        if (!question) {
          alert('Please enter a question');
          return;
        }
        
        showPermanentLoading();
        
        try {
          const answer = await getAnswerFromData(question);
          displayPermanentAnswer(answer);
        } catch (error) {
          console.error('Error getting answer:', error);
          displayPermanentAnswer('Sorry, I encountered an error while processing your question. Please try again.');
        }
      }

      // Quick question handler for permanent Q&A
      window.askPermanentQuestion = function(question) {
        const questionInput = document.getElementById('permanentQuestionInput');
        questionInput.value = question;
        handlePermanentQuestion();
      };

      // Show loading state for permanent Q&A
      function showPermanentLoading() {
        const answerDisplay = document.getElementById('permanentAnswerDisplay');
        const answerText = document.getElementById('permanentAnswerText');
        answerText.innerHTML = '<div class="loading-spinner"></div><p>Analyzing your question...</p>';
        answerDisplay.style.display = 'block';
      }

      // Display answer for permanent Q&A
      function displayPermanentAnswer(answer) {
        const answerText = document.getElementById('permanentAnswerText');
        answerText.innerHTML = answer;
        document.getElementById('permanentAnswerDisplay').style.display = 'block';
      }

      // Create Q&A modal dynamically if it doesn't exist
      function createQAModal() {
        const modal = document.createElement('div');
        modal.id = 'qaModal';
        modal.className = 'modal-overlay';
        modal.style.display = 'none';
        modal.innerHTML = `
          <div class="modal-content large-modal">
            <div class="modal-header">
              <h3 class="modal-title">
                <i class="fas fa-question-circle"></i>
                Ask Questions About Your Chat Data
              </h3>
              <button class="modal-close" onclick="closeQAModal()">&times;</button>
            </div>
            <div class="modal-body">
              <div class="qa-input-section">
                <div class="question-input-container">
                  <input type="text" id="questionInput" placeholder="Ask a question about your chat data..." class="question-input">
                  <button id="askQuestionBtn" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Ask
                  </button>
                </div>
                <div class="quick-questions">
                  <p><strong>Quick Questions:</strong></p>
                  <div class="quick-question-chips">
                    <span class="quick-chip" onclick="askQuickQuestion('Who is the most active user?')">Who is the most active user?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('What is the busiest day of the week?')">What is the busiest day of the week?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('What time are most messages sent?')">What time are most messages sent?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('How many messages were sent this week?')">How many messages were sent this week?</span>
                    <span class="quick-chip" onclick="askQuickQuestion('Show me the top 5 users')">Show me the top 5 users</span>
                    <span class="quick-chip" onclick="askQuickQuestion('What are the most active hours?')">What are the most active hours?</span>
                  </div>
                </div>
              </div>
              <div class="qa-answer-section" id="qaAnswerSection" style="display: none;">
                <div class="answer-container">
                  <div class="answer-header">
                    <i class="fas fa-robot"></i>
                    <span>Answer:</span>
                  </div>
                  <div class="answer-content" id="qaAnswerContent"></div>
                </div>
              </div>
              <div class="qa-loading" id="qaLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Analyzing your question...</p>
              </div>
              <div class="qa-help-section">
                <h4><i class="fas fa-lightbulb"></i> How to Ask Questions</h4>
                <div class="help-tips">
                  <div class="help-tip">
                    <strong>User Questions:</strong> "Who is the most active user?", "Show me user activity for John"
                  </div>
                  <div class="help-tip">
                    <strong>Time Questions:</strong> "What's the busiest day?", "When are most messages sent?"
                  </div>
                  <div class="help-tip">
                    <strong>Activity Questions:</strong> "How many messages this week?", "Show me the leaderboard"
                  </div>
                  <div class="help-tip">
                    <strong>Data Questions:</strong> "What's the total message count?", "Show me weekly breakdown"
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        console.log('Q&A Modal created dynamically');
        
        // Now try to show it
        setTimeout(() => {
          showQAModal();
        }, 100);
      }

      window.showSentimentDetails = function(sentiment) {
        if (sentiment === 'negative') {
          showNegativeModal();
        } else {
          console.log(`Showing ${sentiment} sentiment details`);
        }
      };

      // Activity Analysis Functions
      async function analyzeActivity() {
        const startDate = document.getElementById('activityStartDate').value;
        const endDate = document.getElementById('activityEndDate').value;
        
        
        if (!currentGroup) {
          showActivityError('Please select a group first.');
          return;
        }
        
        if (!startDate || !endDate) {
          showActivityError('Please select both start and end dates.');
          return;
        }
        
        showActivityLoading();
        
        // Simulate progress updates
        const progressSteps = [
          { text: 'Loading chat data...', progress: 20 },
          { text: 'Filtering messages...', progress: 40 },
          { text: 'Calculating metrics...', progress: 60 },
          { text: 'Generating insights...', progress: 80 },
          { text: 'Finalizing analysis...', progress: 100 }
        ];
        
        let currentStep = 0;
        const progressInterval = setInterval(() => {
          if (currentStep < progressSteps.length) {
            const step = progressSteps[currentStep];
            document.getElementById('loadingText').textContent = step.text;
            document.getElementById('progressFill').style.width = step.progress + '%';
            currentStep++;
          }
        }, 1000);
        
        try {
          const data = await makeRequest('/activity_analysis/', {
            group_name: currentGroup,
            start_date: startDate,
            end_date: endDate,
            include_messages: true
          }, 60000); // 60 second timeout
          clearInterval(progressInterval);
          
          console.log('Activity analysis response:', data);
          
          if (data.error) {
            showActivityError(data.error);
            return;
          }
          if ((!data.weeks || data.weeks.length === 0) && (!data.message_counts || Object.keys(data.message_counts).length === 0)) {
            showActivityError('No activity data found for the selected group and date range.');
            return;
          }
          activityData = data;
          
          // Convert string keys to integers for main activity data
          const mainDailyActivity = {};
          const mainHourlyActivity = {};
          
          if (data.daily_activity) {
            Object.entries(data.daily_activity).forEach(([key, value]) => {
              mainDailyActivity[parseInt(key)] = value;
            });
          }
          
          if (data.hourly_activity) {
            Object.entries(data.hourly_activity).forEach(([key, value]) => {
              mainHourlyActivity[parseInt(key)] = value;
            });
          }
          
          const processedData = {
            ...data,
            daily_activity: mainDailyActivity,
            hourly_activity: mainHourlyActivity
          };
          
          console.log('Processed main activity data:', processedData);
          
          displayQuickInsights(processedData);
          // Populate user filter dropdown
          populateUserFilter(data.all_users || []);
          // Generate week cards if weekly data is present
          if (data.weeks) {
            displayWeekCards(data.weeks);
          }
          // Always show week navigation and analysis view after analysis
          document.getElementById('weekNavigation').style.display = 'block';
          document.getElementById('analysisView').style.display = 'block';
          // Render charts and leaderboard
          createActivityCharts(processedData);
          createLeaderboard(data);
          addToHistory('Activity Analysis', { start_date: startDate, end_date: endDate }, 'success', {
            activityData: data,
            totalMessages: data.total_messages || 0,
            totalUsers: data.total_users || 0,
            mostActiveUser: data.message_counts ? Object.keys(data.message_counts).reduce((a, b) => data.message_counts[a] > data.message_counts[b] ? a : b) : 'N/A',
            peakTime: data.hourly_activity ? Object.keys(data.hourly_activity).reduce((a, b) => data.hourly_activity[a] > data.hourly_activity[b] ? a : b) + ':00' : 'N/A'
          });
      } catch (error) {
        clearInterval(progressInterval);
        console.error('Activity analysis error:', error);
        showActivityError('Failed to analyze activity. Please try again.');
      }
    }


      // Helper to populate user filter
      function populateUserFilter(users) {
        const userFilter = document.getElementById('userFilter');
        userFilter.innerHTML = '<option value="">All Users</option>';
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user;
          option.textContent = user;
          userFilter.appendChild(option);
        });
      }

      // Helper to display week cards and handle click
      function displayWeekCards(weeks) {
        const weekCards = document.getElementById('weekCards');
        weekCards.innerHTML = '';
        weeks.forEach((week, idx) => {
          const card = document.createElement('div');
          card.className = 'week-card';
          card.innerHTML = `<div class="week-card-title">Week ${idx + 1}</div><div class="week-card-subtitle">${week.start} - ${week.end}</div>`;
          card.addEventListener('click', () => {
            // Remove selected class from all cards
            document.querySelectorAll('.week-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectWeek(week, idx);
          });
          weekCards.appendChild(card);
        });
      }

      // When a week is selected, update dashboard for that week
      // Select a week and update dashboard for that week (no extra API call, use week data)
      function selectWeek(week, idx) {
        console.log('selectWeek called with:', week, 'index:', idx);
        console.log('Week data:', {
          daily_activity: week.daily_activity,
          hourly_activity: week.hourly_activity,
          message_counts: week.message_counts
        });
        
        // Update period title
        document.getElementById('periodTitle').textContent = `Week ${idx + 1}: ${week.start} - ${week.end}`;
        
        // Check if week has data
        const hasData = week.message_count > 0 && Object.keys(week.message_counts || {}).length > 0;
        
        if (!hasData) {
          // Show reason for no data
          showWeekNoDataReason(week, idx);
          return;
        }
        
        // Show analysis view, hide week nav
        document.getElementById('analysisView').style.display = 'block';
        document.getElementById('weekNavigation').style.display = 'none';
        // Show back button
        document.getElementById('backToWeeks').style.display = 'inline-flex';
        
        // Populate user filter with users for this week
        populateUserFilter(week.users || []);
        
        // Convert string keys to integers for proper processing
        const dailyActivity = {};
        const hourlyActivity = {};
        
        if (week.daily_activity) {
          Object.entries(week.daily_activity).forEach(([key, value]) => {
            dailyActivity[parseInt(key)] = value;
          });
        }
        
        if (week.hourly_activity) {
          Object.entries(week.hourly_activity).forEach(([key, value]) => {
            hourlyActivity[parseInt(key)] = value;
          });
        }

        console.log('Converted daily activity:', dailyActivity);
        console.log('Converted hourly activity:', hourlyActivity);
        
        // Show insights for this week
        displayQuickInsights({
          daily_activity: dailyActivity,
          hourly_activity: hourlyActivity,
          message_counts: week.message_counts,
        });
        
        // Render charts for this week
        createActivityCharts({
          daily_activity: dailyActivity,
          hourly_activity: hourlyActivity,
          message_counts: week.message_counts,
        });
        
        // Render leaderboard for this week
        createLeaderboard({ message_counts: week.message_counts });
      }

      // Show reason when week has no data
      function showWeekNoDataReason(week, idx) {
        // Show analysis view, hide week nav
        document.getElementById('analysisView').style.display = 'block';
        document.getElementById('weekNavigation').style.display = 'none';
        // Show back button
        document.getElementById('backToWeeks').style.display = 'inline-flex';
        
        // Hide all analysis content
        document.getElementById('quickInsights').style.display = 'none';
        document.getElementById('activityCharts').style.display = 'none';
        document.getElementById('userDistribution').style.display = 'none';
        document.getElementById('leaderboard').style.display = 'none';
        
        // Show no data message
        const noDataMessage = document.getElementById('activityEmpty');
        noDataMessage.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
            <i class="fas fa-calendar-times" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
            <h3 style="color: #666; margin-bottom: 1rem;">No Data Available</h3>
            <p style="color: #888; margin-bottom: 0.5rem;">Week ${idx + 1}: ${week.start} - ${week.end}</p>
            <p style="color: #888; font-size: 0.9rem;">
              This week has no messages in the selected date range.<br>
              Try selecting a different week or adjusting your date range.
            </p>
            <button onclick="document.getElementById('weekNavigation').style.display='block'; document.getElementById('analysisView').style.display='none';" 
                    style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
              Back to Week Selection
            </button>
          </div>
        `;
        noDataMessage.style.display = 'block';
      }

      function showActivityLoading() {
        document.getElementById('activityEmpty').style.display = 'none';
        document.getElementById('quickInsights').style.display = 'none';
        document.getElementById('analysisView').style.display = 'none';
        document.getElementById('activityLoading').style.display = 'block';
      }

      function showActivityError(message) {
        document.getElementById('activityLoading').style.display = 'none';
        document.getElementById('quickInsights').style.display = 'none';
        document.getElementById('analysisView').style.display = 'none';
        document.getElementById('activityEmpty').style.display = 'block';
        document.getElementById('activityEmpty').innerHTML = `
          <i class="fas fa-exclamation-triangle" style="color: var(--error);"></i>
          <h3>Analysis Failed</h3>
          <p style="color: var(--error);">${message}</p>
        `;
      }

      function displayQuickInsights(data) {
        console.log('displayQuickInsights called with data:', data);
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        
        // Find most active day
        let mostActiveDay = null;
        let maxDayCount = 0;
        if (data.daily_activity) {
          console.log('Processing daily_activity:', data.daily_activity);
          Object.entries(data.daily_activity).forEach(([day, count]) => {
            if (count > maxDayCount) {
              maxDayCount = count;
              mostActiveDay = days[parseInt(day)];
            }
          });
        }

        // Find peak hour
        let peakHour = null;
        let maxHourCount = 0;
        if (data.hourly_activity) {
          Object.entries(data.hourly_activity).forEach(([hour, count]) => {
            if (count > maxHourCount) {
              maxHourCount = count;
              peakHour = `${hour}:00`;
            }
          });
        }

        // Find most active user
        let mostActiveUser = null;
        let maxUserCount = 0;
        if (data.message_counts) {
          Object.entries(data.message_counts).forEach(([user, count]) => {
            if (count > maxUserCount) {
              maxUserCount = count;
              mostActiveUser = user;
            }
          });
        }

        // Calculate total messages
        const totalMessages = data.message_counts ? 
          Object.values(data.message_counts).reduce((sum, count) => sum + count, 0) : 0;

        // Update insights
        document.getElementById('mostActiveDay').textContent = mostActiveDay || 'N/A';
        document.getElementById('peakHour').textContent = peakHour || 'N/A';
        document.getElementById('totalMessages').textContent = totalMessages.toLocaleString();
        document.getElementById('mostActiveUser').textContent = mostActiveUser || 'N/A';

        // Show insights
        document.getElementById('activityLoading').style.display = 'none';
        document.getElementById('activityEmpty').style.display = 'none';
        document.getElementById('quickInsights').style.display = 'grid';
      }

      function handleUserFilterChange() {
        const selectedUser = document.getElementById('userFilter').value;
        // Find the selected week card
        const selectedCard = document.querySelector('.week-card.selected');
        if (!selectedCard) return;
        // Find the week index from the card
        const weekIdx = Array.from(document.querySelectorAll('.week-card')).indexOf(selectedCard);
        if (weekIdx === -1 || !activityData.weeks) return;
        const week = activityData.weeks[weekIdx];
        if (!week) return;
        // If no user selected, show all data for week
        if (!selectedUser) {
          displayQuickInsights({
            daily_activity: week.daily_activity,
            hourly_activity: week.hourly_activity,
            message_counts: week.message_counts,
          });
          createActivityCharts({
            daily_activity: week.daily_activity,
            hourly_activity: week.hourly_activity,
            message_counts: week.message_counts,
          });
          createLeaderboard({ message_counts: week.message_counts });
          return;
        }
        // Filter week data for selected user
        const userDaily = {};
        Object.entries(week.daily_activity).forEach(([k, v]) => { userDaily[k] = 0; });
        const userHourly = {};
        Object.entries(week.hourly_activity).forEach(([k, v]) => { userHourly[k] = 0; });
        // We need to filter week messages for this user
        // (week.message_counts, week.daily_activity, week.hourly_activity are already available)
        // But we need to reconstruct per-user daily/hourly from week messages if available
        // For now, if week.messages is not available, just zero out others
        if (week.messages) {
          week.messages.filter(m => m.sender === selectedUser).forEach(m => {
            const dt = m.timestamp ? new Date(m.timestamp) : null;
            if (dt) {
              userDaily[dt.getDay()] = (userDaily[dt.getDay()] || 0) + 1;
              userHourly[dt.getHours()] = (userHourly[dt.getHours()] || 0) + 1;
            }
          });
        }
        // Only show this user's message count
        const userMessageCounts = { [selectedUser]: week.message_counts[selectedUser] || 0 };
        displayQuickInsights({
          daily_activity: userDaily,
          hourly_activity: userHourly,
          message_counts: userMessageCounts,
        });
        createActivityCharts({
          daily_activity: userDaily,
          hourly_activity: userHourly,
          message_counts: userMessageCounts,
        });
        createLeaderboard({ message_counts: userMessageCounts });
      }

      function createActivityCharts(data) {
        // Destroy existing charts
        Object.values(activityCharts).forEach(chart => {
          if (chart) chart.destroy();
        });
        
        // Create hourly activity chart
        createHourlyChart(data.hourly_activity || {});
        
        // Create daily activity chart
        createDailyChart(data.daily_activity || {});
        
        // Create user distribution chart
        createUserDistributionChart(data.message_counts || {});
      }

      function createHourlyChart(hourlyData) {
        console.log('createHourlyChart called with data:', hourlyData);
        const ctx = document.getElementById('hourlyChart').getContext('2d');
        
        const hours = Array.from({length: 24}, (_, i) => i);
        const counts = hours.map(hour => hourlyData[hour] || 0);
        console.log('Hourly chart counts:', counts);
        
        activityCharts.hourly = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: hours.map(h => `${h}:00`),
            datasets: [{
              label: 'Messages',
              data: counts,
              backgroundColor: 'rgba(18, 140, 126, 0.6)',
              borderColor: 'rgba(18, 140, 126, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: (items) => `${items[0].label} - ${parseInt(items[0].label) + 1}:00`,
                  label: (item) => `${item.parsed.y} messages`
                }
              }
            }
          }
        });
      }

      function createDailyChart(dailyData) {
        console.log('createDailyChart called with data:', dailyData);
        const ctx = document.getElementById('activityDailyChart').getContext('2d');
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const counts = days.map((_, index) => dailyData[index] || 0);
        console.log('Daily chart counts:', counts);
        
        activityCharts.daily = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: days,
            datasets: [{
              label: 'Messages',
              data: counts,
              backgroundColor: 'rgba(37, 211, 102, 0.6)',
              borderColor: 'rgba(37, 211, 102, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(0, 0, 0, 0.05)' }
              },
              x: { grid: { display: false } }
            },
            plugins: {
              legend: { display: false },
              tooltip: { callbacks: { label: (item) => `${item.parsed.y} messages` } }
            }
          }
        });
      }

      function createUserDistributionChart(messageCounts) {
        console.log('createUserDistributionChart called with data:', messageCounts);
        const ctx = document.getElementById('userDistributionChart').getContext('2d');
        
        const users = Object.keys(messageCounts).slice(0, 5); // Top 5 users
        const counts = users.map(user => messageCounts[user]);
        console.log('User distribution users:', users, 'counts:', counts);
        
        const colors = [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
          '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
        ];
        
        activityCharts.userDistribution = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: users,
            datasets: [{
              data: counts,
              backgroundColor: colors,
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 15,
                  usePointStyle: true,
                  font: {
                    size: 12
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: (item) => `${item.label}: ${item.parsed} messages (${Math.round(item.parsed / counts.reduce((a,b) => a+b, 0) * 100)}%)`
                }
              }
            }
          }
        });
      }

      function createLeaderboard(data) {
        console.log('createLeaderboard called with data:', data);
        const leaderboard = document.getElementById('userLeaderboard');
        leaderboard.innerHTML = '';
        
        if (!data.message_counts) {
          console.log('No message_counts data found');
          return;
        }
        
        const sortedUsers = Object.entries(data.message_counts)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 5);
        
        const maxCount = sortedUsers[0] ? sortedUsers[0][1] : 1;
        
        sortedUsers.forEach(([user, count], index) => {
          const item = document.createElement('div');
          item.className = 'leaderboard-item';
          
          const percentage = (count / maxCount) * 100;
          
          item.innerHTML = `
            <div class="leaderboard-rank ${index < 3 ? 'top-3' : ''}">${index + 1}</div>
            <div class="leaderboard-user">${user}</div>
            <div class="leaderboard-count">${count}</div>
            <div class="leaderboard-bar">
              <div class="leaderboard-progress" style="width: ${percentage}%"></div>
            </div>
          `;
          
          leaderboard.appendChild(item);
        });
      }

      // Topics Function
      async function analyzeTopics() {
        const startDate = document.getElementById('topicsStartDate').value;
        const endDate = document.getElementById('topicsEndDate').value;
        const topN = document.getElementById('topN')?.value || 5;
        
        if (!currentGroup) {
          showError('topicsResult', 'Please select a group first.');
          return;
        }
        
        showLoading('topicsResult');
        
        try {
          const data = await makeRequest('/topic_analysis/', {
            group_name: currentGroup,
            start_date: startDate,
            end_date: endDate,
            top_n: Number(topN)
          });
          
          let content = '<div class="topics-analysis">';
          
          if (data.topics && data.topics.length > 0) {
            content += '<h3>Top Topics</h3><ol>';
            data.topics.forEach(topic => {
              content += `<li>${topic.topic} (score: ${topic.score.toFixed(2)})</li>`;
            });
            content += '</ol>';
          } else {
            content += '<p>No topics found.</p>';
          }
          
          content += '</div>';
          document.getElementById('topicsResult').innerHTML = content;
          
          addToHistory('Topics Analysis', { dateRange: `${startDate} - ${endDate}` });
        } catch (error) {
          console.error('Topics error:', error);
          showError('topicsResult', 'Failed to analyze topics. Please try again.');
        }
      }

      // History Function
      function clearHistory() {
        if (confirm('Are you sure you want to clear your analysis history?')) {
          analysisHistory = [];
          localStorage.removeItem('analysisHistory');
          updateHistoryDisplay();
        }
      }

      function viewFullAnalysis(entryId) {
        const entry = analysisHistory.find(e => e.id === entryId);
        if (!entry) return;

        // Switch to the appropriate section and show the results
        const sectionMap = {
          'Generate Summary': 'summary',
          'Ask Questions': 'questions',
          'Group Events Analysis': 'events',
          'Sentiment Analysis': 'sentiment',
          'Activity Analysis': 'activity'
        };

        const targetSection = sectionMap[entry.type];
        if (targetSection) {
          // Switch to the section
          switchSection(targetSection);
          
          // Show the saved results if available
          if (entry.savedResults) {
            setTimeout(() => {
              displaySavedResults(entry.savedResults, targetSection);
            }, 100);
          }
        }
      }

      function displaySavedResults(savedResults, section) {
        // Display the saved results in the appropriate section
        if (section === 'summary' && savedResults.summary) {
          showResult('summaryResult', savedResults.summary);
        } else if (section === 'sentiment' && savedResults.sentimentResult) {
          // Display sentiment results
          console.log('Displaying sentiment results:', savedResults.sentimentResult);
        } else if (section === 'activity' && savedResults.activityAnalysis) {
          // Display activity results
          console.log('Displaying activity results:', savedResults.activityAnalysis);
        } else if (section === 'events' && savedResults.groupEvents) {
          // Display group events results
          console.log('Displaying group events results:', savedResults.groupEvents);
        }
      }

      function downloadReport(entryId) {
        const entry = analysisHistory.find(e => e.id === entryId);
        if (!entry) return;

        // Create a comprehensive report
        const report = generateComprehensiveReport(entry);
        
        // Create and download the report
        const blob = new Blob([report], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analysis-report-${entry.id}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }

      function generateComprehensiveReport(entry) {
        const { fileInfo, highlights, savedResults } = entry;
        
        let report = `📊 COMPREHENSIVE ANALYSIS REPORT\n`;
        report += `=====================================\n\n`;
        
        // File Information
        report += `📁 FILE INFORMATION\n`;
        report += `File Name: ${fileInfo.fileName}\n`;
        report += `Date Range: ${fileInfo.dateRange}\n`;
        report += `Total Participants: ${highlights.totalParticipants}\n`;
        report += `Total Messages: ${highlights.totalMessages}\n\n`;
        
        // Highlights
        report += `⭐ QUICK HIGHLIGHTS\n`;
        report += `Most Active User: ${highlights.mostActiveUser}\n`;
        report += `Overall Sentiment: ${highlights.overallSentiment?.positive || 0}% positive, ${highlights.overallSentiment?.negative || 0}% negative\n`;
        report += `Peak Active Time: ${highlights.peakActiveTime}\n\n`;
        
        // Saved Results
        if (savedResults.summary) {
          report += `📝 SUMMARY\n`;
          report += `${savedResults.summary}\n\n`;
        }
        
        if (savedResults.groupEvents) {
          report += `📅 GROUP EVENTS\n`;
          report += `${JSON.stringify(savedResults.groupEvents, null, 2)}\n\n`;
        }
        
        if (savedResults.sentimentResult) {
          report += `💝 SENTIMENT ANALYSIS\n`;
          report += `${JSON.stringify(savedResults.sentimentResult, null, 2)}\n\n`;
        }
        
        if (savedResults.activityAnalysis) {
          report += `📈 ACTIVITY ANALYSIS\n`;
          report += `${JSON.stringify(savedResults.activityAnalysis, null, 2)}\n\n`;
        }
        
        report += `Generated on: ${new Date().toLocaleString()}\n`;
        report += `Analysis ID: ${entry.id}\n`;
        
        return report;
      }

      function deleteHistoryEntry(entryId) {
        if (confirm('Are you sure you want to delete this analysis entry?')) {
          analysisHistory = analysisHistory.filter(e => e.id !== entryId);
          localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
          updateHistoryDisplay();
        }
      }
    })();
  </script>
</body>
</html>